modules = ["python-3.11", "postgresql-16"]

[nix]
channel = "stable-24_05"
packages = ["SDL2", "SDL2_image", "SDL2_mixer", "SDL2_ttf", "cacert", "cairo", "cargo", "cmake", "curl", "ffmpeg-full", "fontconfig", "freetype", "gcc", "ghostscript", "glibcLocales", "gnumake", "gobject-introspection", "gtk3", "lcms2", "libiconv", "libimagequant", "libjpeg", "libpng", "libsndfile", "libtiff", "libwebp", "libxcrypt", "openjpeg", "openssl", "pkg-config", "portaudio", "portmidi", "postgresql", "qhull", "rustc", "tcl", "tk", "zlib"]

[deployment]
deploymentTarget = "cloudrun"
run = ["sh", "-c", "gunicorn --config gunicorn.conf.py main:app"]
ignorePorts = false

[env]
PORT = "8080"
FLASK_APP = "main.py"
FLASK_ENV = "production"
PYTHONPATH = "${PYTHONPATH}:${REPL_HOME}"
PYTHONUNBUFFERED = "1"

[tasks]
startApp = "gunicorn --config gunicorn.conf.py main:app"
clearSession = "rm -rf flask_session/* && mkdir -p flask_session"
resetDb = "rm -rf instance/*.sqlite && python run_migrations.py"

[files.watchPatterns]
paths = ["*.py", "templates/**/*.html", "static/**/*"]
ignore = ["__pycache__", "*.pyc", "instance", "flask_session"]

[unitTest]
language = "python"

[auth]
pageEnabled = false
buttonEnabled = false

[server]
host = "0.0.0.0"
port = 8080
run = ["sh", "-c", "gunicorn --config gunicorn.conf.py main:app"]

[workflow]
onBoot = ["startApp"]

[[ports]]
localPort = 5000
externalPort = 80

[[ports]]
localPort = 8080
externalPort = 8080

[workflows]
runButton = "Run App"

[[workflows.workflow]]
name = "Run App"
author = 42669439
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"gunicorn.*main:app\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "mkdir -p logs static templates flask_session instance"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "export PORT=8080"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "export FLASK_APP=main.py"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "export FLASK_ENV=production"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "gunicorn --config gunicorn.conf.py main:app"
