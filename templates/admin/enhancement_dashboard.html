<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOUS Enhancement Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .enhancement-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .enhancement-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .priority-high {
            border-left-color: #dc3545;
        }
        .priority-medium {
            border-left-color: #ffc107;
        }
        .priority-low {
            border-left-color: #28a745;
        }
        .health-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .health-healthy {
            background-color: #28a745;
        }
        .health-degraded {
            background-color: #ffc107;
        }
        .health-critical {
            background-color: #dc3545;
        }
        .system-metrics {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .code-analysis {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85em;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tools me-2"></i>NOUS Enhancement Dashboard
            </span>
            <div class="d-flex">
                <button class="btn btn-outline-light btn-sm me-2" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-home me-1"></i>Back to App
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- System Health Overview -->
            <div class="col-12 mb-4">
                <div class="card system-metrics">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>System Health Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Cache System</h6>
                                    <span class="health-indicator {% if system_health.cache_system %}health-healthy{% else %}health-critical{% endif %}"></span>
                                    <span>{% if system_health.cache_system %}Active{% else %}Unavailable{% endif %}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Enhancement Engine</h6>
                                    <span class="health-indicator {% if system_health.enhancement_system %}health-healthy{% else %}health-critical{% endif %}"></span>
                                    <span>{% if system_health.enhancement_system %}Active{% else %}Unavailable{% endif %}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Monitoring</h6>
                                    <span class="health-indicator {% if system_health.monitoring_active %}health-healthy{% else %}health-degraded{% endif %}"></span>
                                    <span>{% if system_health.monitoring_active %}Active{% else %}Limited{% endif %}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>Last Analysis</h6>
                                    <small id="lastAnalysisTime">{{ system_health.last_analysis }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="col-md-6 mb-4">
                <div class="card enhancement-card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Enhancement Statistics</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 class="text-primary" id="totalOpportunities">{{ stats.enhancement_opportunities or 0 }}</h4>
                                <small class="text-muted">Total Opportunities</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-danger" id="highPriority">{{ stats.high_priority or 0 }}</h4>
                                <small class="text-muted">High Priority</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-success" id="cacheHitRate">
                                    {% if stats.cache %}{{ "%.1f"|format(stats.cache.statistics.hit_rate_percent) }}%{% else %}N/A{% endif %}
                                </h4>
                                <small class="text-muted">Cache Hit Rate</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-md-6 mb-4">
                <div class="card enhancement-card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="runAnalysis()">
                                <i class="fas fa-search me-1"></i>Run Full Analysis
                            </button>
                            <button class="btn btn-success btn-sm" onclick="applySafeFixes()">
                                <i class="fas fa-magic me-1"></i>Apply Safe Fixes
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="clearCache()">
                                <i class="fas fa-trash me-1"></i>Clear Cache
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhancement Opportunities -->
        <div class="row">
            <div class="col-12">
                <div class="card enhancement-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-list me-2"></i>Enhancement Opportunities</h6>
                        <div>
                            <select class="form-select form-select-sm me-2" id="categoryFilter" onchange="filterOpportunities()">
                                <option value="">All Categories</option>
                                <option value="Performance">Performance</option>
                                <option value="Code Quality">Code Quality</option>
                                <option value="Documentation">Documentation</option>
                                <option value="Monitoring">Monitoring</option>
                            </select>
                            <select class="form-select form-select-sm" id="priorityFilter" onchange="filterOpportunities()">
                                <option value="">All Priorities</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="opportunitiesList">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Loading enhancement opportunities...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div class="row mt-4" id="analysisResults" style="display: none;">
            <div class="col-12">
                <div class="card enhancement-card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-microscope me-2"></i>Analysis Results</h6>
                    </div>
                    <div class="card-body">
                        <div id="analysisContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <i class="fas fa-cogs fa-spin fa-3x text-primary mb-3"></i>
                    <h5 id="loadingText">Processing...</h5>
                    <p class="text-muted">This may take a few moments</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let loadingModal;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadOpportunities();
            
            // Update timestamp display
            updateLastAnalysisTime();
        });

        function showLoading(text = 'Processing...') {
            document.getElementById('loadingText').textContent = text;
            loadingModal.show();
        }

        function hideLoading() {
            loadingModal.hide();
        }

        function updateLastAnalysisTime() {
            const timeElement = document.getElementById('lastAnalysisTime');
            if (timeElement.textContent) {
                const time = new Date(timeElement.textContent);
                if (!isNaN(time)) {
                    timeElement.textContent = time.toLocaleString();
                }
            }
        }

        async function loadOpportunities() {
            try {
                const response = await fetch('/admin/enhancements/api/opportunities?limit=20');
                const result = await response.json();
                
                if (result.success) {
                    displayOpportunities(result.data);
                } else {
                    displayError('Failed to load opportunities: ' + result.message);
                }
            } catch (error) {
                displayError('Error loading opportunities: ' + error.message);
            }
        }

        function displayOpportunities(opportunities) {
            const container = document.getElementById('opportunitiesList');
            
            if (!opportunities || opportunities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                        <p>No enhancement opportunities found. System is optimized!</p>
                    </div>
                `;
                return;
            }

            const html = opportunities.map(opp => `
                <div class="card mb-2 enhancement-card priority-${opp.priority}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">
                                    <span class="badge bg-${getPriorityColor(opp.priority)} me-2">${opp.priority.toUpperCase()}</span>
                                    ${opp.description}
                                </h6>
                                <p class="text-muted mb-1 small">${opp.file_path}</p>
                                <p class="mb-0 small">${opp.suggested_action}</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted d-block">Category: ${opp.category}</small>
                                <small class="text-muted d-block">Effort: ${opp.estimated_effort}</small>
                                <small class="text-muted">Impact: ${opp.potential_impact}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 'high': return 'danger';
                case 'medium': return 'warning';
                case 'low': return 'success';
                default: return 'secondary';
            }
        }

        function displayError(message) {
            document.getElementById('opportunitiesList').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>${message}
                </div>
            `;
        }

        async function runAnalysis() {
            showLoading('Running comprehensive analysis...');
            
            try {
                const response = await fetch('/admin/enhancements/api/analysis');
                const result = await response.json();
                
                if (result.success) {
                    displayAnalysisResults(result.data);
                    await loadOpportunities(); // Refresh opportunities
                    updateStats(result.data);
                } else {
                    alert('Analysis failed: ' + result.message);
                }
            } catch (error) {
                alert('Error running analysis: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function applySafeFixes() {
            showLoading('Applying safe fixes...');
            
            try {
                const response = await fetch('/admin/enhancements/api/apply-fixes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ max_fixes: 5 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Applied ${result.data.fixes_applied} fixes successfully!`);
                    await loadOpportunities(); // Refresh opportunities
                } else {
                    alert('Failed to apply fixes: ' + result.message);
                }
            } catch (error) {
                alert('Error applying fixes: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function clearCache() {
            if (!confirm('Are you sure you want to clear the cache?')) {
                return;
            }
            
            showLoading('Clearing cache...');
            
            try {
                const response = await fetch('/admin/enhancements/api/cache/clear', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Cache cleared successfully!');
                    refreshDashboard();
                } else {
                    alert('Failed to clear cache: ' + result.message);
                }
            } catch (error) {
                alert('Error clearing cache: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displayAnalysisResults(data) {
            const container = document.getElementById('analysisContent');
            const resultsDiv = document.getElementById('analysisResults');
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Summary</h6>
                        <ul>
                            <li>Files Analyzed: ${data.summary.total_files_analyzed}</li>
                            <li>Total Opportunities: ${data.summary.total_opportunities}</li>
                            <li>Average Complexity: ${data.summary.average_complexity}</li>
                            <li>High Priority: ${data.summary.high_priority_count}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Top Recommendations</h6>
                        <ul>
                            ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        function updateStats(data) {
            document.getElementById('totalOpportunities').textContent = data.summary.total_opportunities;
            document.getElementById('highPriority').textContent = data.summary.high_priority_count;
        }

        async function filterOpportunities() {
            const category = document.getElementById('categoryFilter').value;
            const priority = document.getElementById('priorityFilter').value;
            
            const params = new URLSearchParams();
            if (category) params.append('category', category);
            if (priority) params.append('priority', priority);
            
            try {
                const response = await fetch(`/admin/enhancements/api/opportunities?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    displayOpportunities(result.data);
                }
            } catch (error) {
                displayError('Error filtering opportunities: ' + error.message);
            }
        }

        function refreshDashboard() {
            location.reload();
        }
    </script>
</body>
</html>