{% extends "layout.html" %}

{% block title %}Chat with NOUS{% endblock %}

{% block styles %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 160px);
        min-height: 500px;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: var(--bs-light);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }
    
    .chat-input-container {
        display: flex;
        gap: 0.5rem;
    }
    
    .chat-input {
        flex: 1;
    }
    
    .message {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .user-message {
        background-color: var(--bs-primary);
        color: white;
        align-self: flex-end;
        margin-left: auto;
    }
    
    .assistant-message {
        background-color: var(--bs-light);
        border: 1px solid var(--bs-border-color);
        align-self: flex-start;
    }
    
    .message-container {
        display: flex;
        flex-direction: column;
    }
    
    .typing-indicator {
        display: flex;
        padding: 0.75rem 1rem;
        background-color: var(--bs-light);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        align-self: flex-start;
        margin-bottom: 0.75rem;
        width: fit-content;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        margin: 0 2px;
        background-color: #888;
        border-radius: 50%;
        opacity: 0.6;
        animation: typing 1.4s infinite both;
    }
    
    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-5px);
        }
    }
    
    .command-result {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: var(--bs-light);
        border: 1px solid var(--bs-border-color);
        margin-top: 0.5rem;
    }
    
    .meeting-card {
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    
    .meeting-icon {
        font-size: 1.25rem;
        margin-right: 0.5rem;
    }
    
    .meeting-link {
        margin-top: 0.5rem;
    }
    
    .agenda-text {
        white-space: pre-line;
        font-size: 0.9rem;
        padding: 0.75rem;
        background-color: rgba(0,0,0,0.03);
        border-radius: 0.375rem;
        margin-top: 0.5rem;
    }
    
    .command-help {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Chat with NOUS</h1>
            <p class="lead">Ask questions, get information, or use commands to manage Google Meet meetings.</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages">
                    <div class="message-container">
                        <div class="message assistant-message">
                            Hello! I'm NOUS, your recovery assistant. How can I help you today? You can ask me questions, 
                            chat, or try commands like "Schedule a therapy session" or "Create a recovery group meeting."
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <textarea id="chat-input" class="form-control chat-input" placeholder="Type your message here..." rows="2"></textarea>
                    <button id="send-button" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <div class="command-help mt-2">
                    <small>
                        <i class="fas fa-lightbulb text-warning"></i> 
                        <strong>Meeting Commands:</strong> create meeting, schedule therapy, create recovery group, sponsor meeting, mindfulness session, list meetings, generate agenda, analyze notes
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        
        // Load chat history on page load
        loadChatHistory();
        
        // Send message when send button is clicked
        sendButton.addEventListener('click', sendMessage);
        
        // Send message when Enter key is pressed (without Shift)
        chatInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        // Function to load chat history
        function loadChatHistory() {
            fetch('/api/chat/history')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.history.length > 0) {
                        // Clear default greeting
                        chatMessages.innerHTML = '';
                        
                        // Display each message in history
                        data.history.forEach(message => {
                            if (message.role === 'user') {
                                displayUserMessage(message.content);
                            } else {
                                displayAssistantMessage(message.content, message.data);
                            }
                        });
                        
                        // Scroll to bottom
                        scrollToBottom();
                    }
                })
                .catch(error => {
                    console.error('Error loading chat history:', error);
                });
        }
        
        // Function to send a message
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Display user message
            displayUserMessage(message);
            
            // Clear input
            chatInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Send message to server
            fetch('/api/chat/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
                .then(response => response.json())
                .then(data => {
                    // Hide typing indicator
                    hideTypingIndicator();
                    
                    if (data.success) {
                        // Display assistant message
                        displayAssistantMessage(data.message, data);
                    } else {
                        // Display error message
                        displayAssistantMessage(`Sorry, I encountered an error: ${data.message}`);
                    }
                    
                    // Scroll to bottom
                    scrollToBottom();
                })
                .catch(error => {
                    // Hide typing indicator
                    hideTypingIndicator();
                    
                    // Display error message
                    displayAssistantMessage('Sorry, I encountered an error. Please try again.');
                    console.error('Error sending message:', error);
                    
                    // Scroll to bottom
                    scrollToBottom();
                });
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Function to display user message
        function displayUserMessage(message) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message user-message';
            messageElement.textContent = message;
            
            messageContainer.appendChild(messageElement);
            chatMessages.appendChild(messageContainer);
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Function to display assistant message
        function displayAssistantMessage(message, data) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message assistant-message';
            messageElement.textContent = message;
            
            messageContainer.appendChild(messageElement);
            
            // If this is a command response with special data, add additional UI elements
            if (data && data.is_command) {
                // For meeting creation
                if (data.meeting) {
                    const meetingCard = document.createElement('div');
                    meetingCard.className = 'meeting-card';
                    
                    const meetingTitle = document.createElement('h5');
                    meetingTitle.innerHTML = '<i class="fas fa-video meeting-icon"></i> ' + data.meeting.title;
                    
                    const meetingTime = document.createElement('div');
                    meetingTime.textContent = `Time: ${data.meeting.time}`;
                    
                    const meetingLink = document.createElement('a');
                    meetingLink.href = data.meeting.link;
                    meetingLink.className = 'btn btn-sm btn-outline-primary meeting-link';
                    meetingLink.textContent = 'Join Meeting';
                    meetingLink.target = '_blank';
                    
                    meetingCard.appendChild(meetingTitle);
                    meetingCard.appendChild(meetingTime);
                    meetingCard.appendChild(meetingLink);
                    
                    messageContainer.appendChild(meetingCard);
                }
                
                // For meeting list
                if (data.meetings && Array.isArray(data.meetings)) {
                    const meetingsContainer = document.createElement('div');
                    meetingsContainer.className = 'command-result';
                    
                    data.meetings.forEach(meeting => {
                        const meetingItem = document.createElement('div');
                        meetingItem.className = 'meeting-card';
                        
                        const meetingTitle = document.createElement('h5');
                        meetingTitle.innerHTML = '<i class="fas fa-video meeting-icon"></i> ' + meeting.title;
                        
                        const meetingTime = document.createElement('div');
                        meetingTime.textContent = `Time: ${formatDateTime(meeting.start_time)}`;
                        
                        const meetingLink = document.createElement('a');
                        meetingLink.href = meeting.meet_link;
                        meetingLink.className = 'btn btn-sm btn-outline-primary meeting-link';
                        meetingLink.textContent = 'Join Meeting';
                        meetingLink.target = '_blank';
                        
                        meetingItem.appendChild(meetingTitle);
                        meetingItem.appendChild(meetingTime);
                        meetingItem.appendChild(meetingLink);
                        
                        meetingsContainer.appendChild(meetingItem);
                    });
                    
                    messageContainer.appendChild(meetingsContainer);
                }
                
                // For agenda generation
                if (data.agenda) {
                    const agendaContainer = document.createElement('div');
                    agendaContainer.className = 'command-result';
                    
                    const agendaTitle = document.createElement('h5');
                    agendaTitle.innerHTML = '<i class="fas fa-clipboard-list meeting-icon"></i> Meeting Agenda';
                    
                    const agendaText = document.createElement('div');
                    agendaText.className = 'agenda-text';
                    agendaText.textContent = data.agenda;
                    
                    agendaContainer.appendChild(agendaTitle);
                    agendaContainer.appendChild(agendaText);
                    
                    messageContainer.appendChild(agendaContainer);
                }
                
                // For notes analysis
                if (data.analysis) {
                    const analysisContainer = document.createElement('div');
                    analysisContainer.className = 'command-result';
                    
                    const analysisTitle = document.createElement('h5');
                    analysisTitle.innerHTML = '<i class="fas fa-chart-line meeting-icon"></i> Meeting Notes Analysis';
                    
                    const analysisText = document.createElement('div');
                    analysisText.className = 'agenda-text';
                    analysisText.textContent = data.analysis;
                    
                    analysisContainer.appendChild(analysisTitle);
                    analysisContainer.appendChild(analysisText);
                    
                    messageContainer.appendChild(analysisContainer);
                }
            }
            
            chatMessages.appendChild(messageContainer);
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Function to show typing indicator
        function showTypingIndicator() {
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.id = 'typing-indicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                typingIndicator.appendChild(dot);
            }
            
            chatMessages.appendChild(typingIndicator);
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Function to hide typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Function to scroll to bottom of chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Helper function to format date-time string
        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }
    });
</script>
{% endblock %} 