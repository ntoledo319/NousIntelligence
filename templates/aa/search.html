{% extends "base.html" %}

{% block title %}Search AA Content{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">AA Content</h5>
                </div>
                <div class="card-body">
                    {% include 'includes/aa_menu.html' %}
                </div>
            </div>
        </div>
        
        <!-- Main content area -->
        <div class="col-md-9">
            <h1 class="display-5 mb-4">Search AA Content</h1>
            
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('aa.aa_content.search') }}">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" name="q" placeholder="Search for a phrase, topic, or keyword..." value="{{ query|default('') }}">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        <div class="form-text">
                            Search the AA Big Book and speaker recordings for content that matches your query.
                        </div>
                    </form>
                </div>
            </div>
            
            {% if query %}
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">AI-Assisted Research</h5>
                    </div>
                    <div class="card-body">
                        <p>Need help understanding concepts related to <strong>"{{ query }}"</strong>?</p>
                        
                        <button class="btn btn-outline-primary mb-3" id="aiAssistBtn">
                            <i class="fas fa-brain"></i> Get AI Insights
                        </button>
                        
                        <div id="aiInsights" class="p-3 rounded bg-light" style="display: none;">
                            <div class="mb-2 text-muted small">AI-Generated Insights:</div>
                            <div id="aiInsightsContent">
                                <div class="spinner-border spinner-border-sm" role="status"></div> Generating insights...
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            {% if results %}
                <div class="alert alert-success">
                    Found {{ results.total_count }} results for <strong>"{{ query }}"</strong>
                </div>
                
                {% if results.big_book|length > 0 %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-book"></i> Big Book Results 
                                <span class="badge bg-secondary">{{ results.big_book|length }}</span>
                            </h5>
                        </div>
                        <div class="list-group list-group-flush">
                            {% for chapter in results.big_book %}
                                <a href="{{ url_for('aa.aa_content.big_book_chapter', chapter_id=chapter.id) }}" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">
                                            {{ chapter.chapter_title }}
                                            {% if chapter.is_foreword %}
                                                <span class="badge bg-info">Foreword</span>
                                            {% elif chapter.is_appendix %}
                                                <span class="badge bg-info">Appendix</span>
                                            {% else %}
                                                <span class="badge bg-primary">Chapter {{ chapter.chapter_number }}</span>
                                            {% endif %}
                                        </h5>
                                    </div>
                                    <p class="mb-1">
                                        {{ chapter.content|truncate(150)|safe }}
                                    </p>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                {% if results.speakers|length > 0 %}
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-microphone"></i> Speaker Recordings 
                                <span class="badge bg-secondary">{{ results.speakers|length }}</span>
                            </h5>
                        </div>
                        <div class="list-group list-group-flush">
                            {% for recording in results.speakers %}
                                <a href="{{ url_for('aa.aa_content.speaker_detail', recording_id=recording.id) }}" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">{{ recording.title }}</h5>
                                        {% if recording.year_recorded %}
                                            <span class="badge bg-secondary">{{ recording.year_recorded }}</span>
                                        {% endif %}
                                    </div>
                                    <p class="mb-1">{{ recording.speaker_name }}</p>
                                    {% if recording.description %}
                                        <p class="mb-1 small text-muted">{{ recording.description|truncate(100) }}</p>
                                    {% endif %}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
            {% elif query %}
                <div class="alert alert-warning">
                    No results found for <strong>"{{ query }}"</strong>. Try a different search term or browse the content directly.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // AI Insights functionality
    const aiAssistBtn = document.getElementById('aiAssistBtn');
    if (aiAssistBtn) {
        const aiInsights = document.getElementById('aiInsights');
        const aiInsightsContent = document.getElementById('aiInsightsContent');
        
        aiAssistBtn.addEventListener('click', function() {
            aiInsights.style.display = 'block';
            
            fetch('{{ url_for("aa.api.ai_ask") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    question: 'Please explain the concept of "{{ query }}" in the context of Alcoholics Anonymous and recovery.',
                    context: {
                        source: 'general',
                        query: '{{ query }}'
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Format the response with paragraphs
                    const formattedResponse = data.response.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
                    aiInsightsContent.innerHTML = `<p>${formattedResponse}</p>`;
                    
                    // Add model info if available
                    if (data.model) {
                        aiInsightsContent.innerHTML += `<p class="mt-3 text-muted small">Powered by: ${data.model}</p>`;
                    }
                } else {
                    aiInsightsContent.innerHTML = '<div class="alert alert-warning">Sorry, I couldn\'t provide insights on this topic right now. Please try again later.</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                aiInsightsContent.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
            });
        });
    }
});
</script>
{% endblock %}