<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coping Skills - CBT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-tools text-primary"></i> Coping Skills Library</h1>
                    <div>
                        <button class="btn btn-info" onclick="getRecommendation()">
                            <i class="fas fa-magic"></i> Get Recommendation
                        </button>
                        <a href="{{ url_for('cbt.dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to CBT Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Categories -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6>Filter by Category:</h6>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('cbt.coping_skills') }}" class="btn btn-outline-secondary {{ 'active' if not selected_category }}">
                                All Skills
                            </a>
                            {% for category in categories %}
                            <a href="{{ url_for('cbt.coping_skills', category=category) }}" 
                               class="btn btn-outline-secondary {{ 'active' if selected_category == category }}">
                                {{ category.title() }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Skills Grid -->
        <div class="row">
            {% if skills %}
                {% for skill in skills %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{{ skill.skill_name }}</h6>
                            <span class="badge bg-{{ 'primary' if skill.category == 'grounding' else 'success' if skill.category == 'relaxation' else 'info' if skill.category == 'cognitive' else 'warning' if skill.category == 'behavioral' else 'secondary' }}">
                                {{ skill.category.title() }}
                            </span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ skill.description }}</p>
                            
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> Duration: {{ skill.duration_minutes or 'Varies' }} minutes
                                </small>
                            </div>
                            
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-signal"></i> Difficulty: 
                                    {% for i in range(1, 6) %}
                                        <i class="fas fa-star {{ 'text-warning' if i <= (skill.difficulty_level or 1) else 'text-muted' }}"></i>
                                    {% endfor %}
                                </small>
                            </div>

                            {% if skill.usage_count > 0 %}
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-users"></i> Used {{ skill.usage_count }} times
                                    {% if skill.average_effectiveness > 0 %}
                                    | Avg rating: {{ "%.1f"|format(skill.average_effectiveness) }}/10
                                    {% endif %}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('cbt.view_coping_skill', skill_id=skill.id) }}" class="btn btn-primary btn-sm flex-fill">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                                <button class="btn btn-success btn-sm" onclick="useSkill({{ skill.id }}, '{{ skill.skill_name }}')">
                                    <i class="fas fa-play"></i> Use Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                        <h4>No skills found</h4>
                        <p class="text-muted">Try adjusting your filter or check back later for more skills.</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Skill Usage Modal -->
    <div class="modal fade" id="skillUsageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Log Skill Usage</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="skillUsageForm">
                        <input type="hidden" id="skillId" value="">
                        
                        <div class="mb-3">
                            <label>Situation (optional)</label>
                            <textarea class="form-control" id="situation" rows="2" 
                                placeholder="Describe what led you to use this skill..."></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label>Mood Before (1-10)</label>
                                <select class="form-select" id="moodBefore">
                                    <option value="">Select...</option>
                                    {% for i in range(1, 11) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <label>Mood After (1-10)</label>
                                <select class="form-select" id="moodAfter">
                                    <option value="">Select...</option>
                                    {% for i in range(1, 11) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>How effective was this skill? (1-10)</label>
                            <select class="form-select" id="effectiveness">
                                <option value="">Select...</option>
                                {% for i in range(1, 11) %}
                                <option value="{{ i }}">{{ i }} - {{ 'Very ineffective' if i <= 2 else 'Ineffective' if i <= 4 else 'Neutral' if i <= 6 else 'Effective' if i <= 8 else 'Very effective' }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Duration used (minutes)</label>
                            <input type="number" class="form-control" id="duration" min="1" max="120">
                        </div>

                        <div class="mb-3">
                            <label>Notes (optional)</label>
                            <textarea class="form-control" id="notes" rows="2" 
                                placeholder="Any additional thoughts or observations..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitSkillUsage()">Log Usage</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendation Modal -->
    <div class="modal fade" id="recommendationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Get Skill Recommendation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recommendationForm">
                        <div class="mb-3">
                            <label>What's your current situation?</label>
                            <textarea class="form-control" id="currentSituation" rows="3" required
                                placeholder="Describe what you're experiencing right now..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label>How are you feeling?</label>
                            <select class="form-select" id="currentEmotion">
                                <option value="">Select emotion...</option>
                                <option value="anxious">Anxious</option>
                                <option value="sad">Sad</option>
                                <option value="angry">Angry</option>
                                <option value="overwhelmed">Overwhelmed</option>
                                <option value="stressed">Stressed</option>
                                <option value="frustrated">Frustrated</option>
                                <option value="panicked">Panicked</option>
                                <option value="worried">Worried</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Intensity (1-10)</label>
                            <input type="range" class="form-range" id="intensity" min="1" max="10" value="5">
                            <div class="text-center">
                                <span id="intensityDisplay">5</span>/10
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="getSkillRecommendation()">Get Recommendation</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update intensity display
        document.getElementById('intensity').addEventListener('input', function() {
            document.getElementById('intensityDisplay').textContent = this.value;
        });

        function useSkill(skillId, skillName) {
            document.getElementById('skillId').value = skillId;
            document.querySelector('#skillUsageModal .modal-title').textContent = `Log Usage: ${skillName}`;
            new bootstrap.Modal(document.getElementById('skillUsageModal')).show();
        }

        async function submitSkillUsage() {
            const skillId = document.getElementById('skillId').value;
            const formData = {
                situation: document.getElementById('situation').value,
                mood_before: document.getElementById('moodBefore').value ? parseInt(document.getElementById('moodBefore').value) : null,
                mood_after: document.getElementById('moodAfter').value ? parseInt(document.getElementById('moodAfter').value) : null,
                effectiveness_rating: document.getElementById('effectiveness').value ? parseInt(document.getElementById('effectiveness').value) : null,
                duration_used: document.getElementById('duration').value ? parseInt(document.getElementById('duration').value) : null,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch(`/cbt/api/coping-skills/${skillId}/use`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('skillUsageModal')).hide();
                    alert('Skill usage logged successfully!');
                    location.reload();
                } else {
                    alert('Error logging skill usage: ' + result.error);
                }
            } catch (error) {
                alert('Error logging skill usage: ' + error.message);
            }
        }

        function getRecommendation() {
            new bootstrap.Modal(document.getElementById('recommendationModal')).show();
        }

        async function getSkillRecommendation() {
            const formData = {
                situation: document.getElementById('currentSituation').value,
                current_emotion: document.getElementById('currentEmotion').value,
                intensity: parseInt(document.getElementById('intensity').value)
            };

            if (!formData.situation) {
                alert('Please describe your current situation.');
                return;
            }

            try {
                const response = await fetch('/cbt/api/coping-skills/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success && result.recommended_skill) {
                    const skill = result.recommended_skill;
                    bootstrap.Modal.getInstance(document.getElementById('recommendationModal')).hide();
                    
                    const message = `Recommended Skill: ${skill.skill_name}\n\n${skill.description}\n\nInstructions:\n${skill.instructions}`;
                    
                    if (confirm(message + '\n\nWould you like to use this skill now?')) {
                        useSkill(skill.id, skill.skill_name);
                    }
                } else {
                    alert('No specific recommendation available. Browse the skills library for options.');
                }
            } catch (error) {
                alert('Error getting recommendation: ' + error.message);
            }
        }
    </script>
</body>
</html>