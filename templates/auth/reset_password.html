{% extends 'base.html' %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center mt-5">
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Reset Your Password</h4>
        </div>
        <div class="card-body">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <form method="POST" action="{{ url_for('secure_login.reset_password', token=token) }}" id="reset-password-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            
            <div class="mb-3">
              <label for="password" class="form-label">New Password</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                <input type="password" class="form-control" id="password" name="password" required
                       placeholder="Enter your new password" minlength="12">
                <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="password-strength mt-2" id="password-strength">
                <div class="progress">
                  <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <small class="text-muted" id="password-feedback">Password must be at least 12 characters long</small>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="confirm_password" class="form-label">Confirm New Password</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required
                       placeholder="Confirm your new password" minlength="12">
              </div>
              <div class="password-match mt-1 d-none" id="password-match">
                <small class="text-success"><i class="fas fa-check-circle"></i> Passwords match</small>
              </div>
              <div class="password-mismatch mt-1 d-none" id="password-mismatch">
                <small class="text-danger"><i class="fas fa-times-circle"></i> Passwords don't match</small>
              </div>
            </div>
            
            <div class="alert alert-info mb-4">
              <h6 class="alert-heading"><i class="fas fa-info-circle"></i> Password Requirements:</h6>
              <ul class="mb-0 ps-3">
                <li id="length-check" class="text-muted">At least 12 characters long</li>
                <li id="uppercase-check" class="text-muted">Contains uppercase letters (A-Z)</li>
                <li id="lowercase-check" class="text-muted">Contains lowercase letters (a-z)</li>
                <li id="number-check" class="text-muted">Contains numbers (0-9)</li>
                <li id="special-check" class="text-muted">Contains special characters (!@#$%^&*)</li>
              </ul>
            </div>
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                <i class="fas fa-save"></i> Set New Password
              </button>
            </div>
          </form>
          
          <div class="mt-3 text-center">
            <a href="{{ url_for('secure_login.login') }}">Return to login</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Toggle password visibility
  document.getElementById('toggle-password').addEventListener('click', function() {
    const passwordInput = document.getElementById('password');
    const icon = this.querySelector('i');
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      passwordInput.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  });
  
  // Password strength checker
  const passwordInput = document.getElementById('password');
  const confirmInput = document.getElementById('confirm_password');
  const submitBtn = document.getElementById('submit-btn');
  const progressBar = document.querySelector('.progress-bar');
  const passwordFeedback = document.getElementById('password-feedback');
  const matchDiv = document.getElementById('password-match');
  const mismatchDiv = document.getElementById('password-mismatch');
  
  // Password requirement checks
  const lengthCheck = document.getElementById('length-check');
  const uppercaseCheck = document.getElementById('uppercase-check');
  const lowercaseCheck = document.getElementById('lowercase-check');
  const numberCheck = document.getElementById('number-check');
  const specialCheck = document.getElementById('special-check');
  
  passwordInput.addEventListener('input', function() {
    const password = this.value;
    let strength = 0;
    
    // Reset all checks
    [lengthCheck, uppercaseCheck, lowercaseCheck, numberCheck, specialCheck].forEach(check => {
      check.classList.remove('text-success');
      check.classList.add('text-muted');
    });
    
    // Check length
    if (password.length >= 12) {
      strength += 20;
      lengthCheck.classList.remove('text-muted');
      lengthCheck.classList.add('text-success');
    }
    
    // Check uppercase
    if (/[A-Z]/.test(password)) {
      strength += 20;
      uppercaseCheck.classList.remove('text-muted');
      uppercaseCheck.classList.add('text-success');
    }
    
    // Check lowercase
    if (/[a-z]/.test(password)) {
      strength += 20;
      lowercaseCheck.classList.remove('text-muted');
      lowercaseCheck.classList.add('text-success');
    }
    
    // Check numbers
    if (/[0-9]/.test(password)) {
      strength += 20;
      numberCheck.classList.remove('text-muted');
      numberCheck.classList.add('text-success');
    }
    
    // Check special characters
    if (/[^A-Za-z0-9]/.test(password)) {
      strength += 20;
      specialCheck.classList.remove('text-muted');
      specialCheck.classList.add('text-success');
    }
    
    // Update progress bar
    progressBar.style.width = strength + '%';
    progressBar.setAttribute('aria-valuenow', strength);
    
    // Set progress bar color
    if (strength < 40) {
      progressBar.className = 'progress-bar bg-danger';
      passwordFeedback.textContent = 'Password is too weak';
    } else if (strength < 80) {
      progressBar.className = 'progress-bar bg-warning';
      passwordFeedback.textContent = 'Password is moderate';
    } else {
      progressBar.className = 'progress-bar bg-success';
      passwordFeedback.textContent = 'Password is strong';
    }
    
    // Check password match
    checkPasswordMatch();
  });
  
  confirmInput.addEventListener('input', checkPasswordMatch);
  
  function checkPasswordMatch() {
    const password = passwordInput.value;
    const confirmPassword = confirmInput.value;
    
    // Only show match indicators if both fields have content
    if (password && confirmPassword) {
      if (password === confirmPassword) {
        matchDiv.classList.remove('d-none');
        mismatchDiv.classList.add('d-none');
      } else {
        matchDiv.classList.add('d-none');
        mismatchDiv.classList.remove('d-none');
      }
    } else {
      matchDiv.classList.add('d-none');
      mismatchDiv.classList.add('d-none');
    }
    
    // Enable submit button if everything is valid
    submitBtn.disabled = !(
      password.length >= 12 &&
      /[A-Z]/.test(password) &&
      /[a-z]/.test(password) &&
      /[0-9]/.test(password) &&
      /[^A-Za-z0-9]/.test(password) &&
      password === confirmPassword
    );
  }
  
  // Form submission
  document.getElementById('reset-password-form').addEventListener('submit', function(e) {
    // Disable submit button to prevent multiple submissions
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
  });
</script>
{% endblock %}