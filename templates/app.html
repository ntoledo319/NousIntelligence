<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NOUS Chat - Intelligent conversation with {{ user.name }}">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NOUS Chat">
    <title>NOUS Chat - {{ user.name }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans" data-theme="light">
    <div id="app" class="flex h-screen antialiased text-gray-800 dark:text-gray-200">
        <!-- Sidebar / Conversation List -->
        <aside id="sidebar" role="navigation" aria-label="Conversations" class="flex-shrink-0 w-80 bg-white dark:bg-gray-800 border-r dark:border-gray-700/50 flex-col md:flex hidden shadow-lg">
            <!-- Utility Bar -->
            <div class="flex-shrink-0 h-16 px-4 flex items-center justify-between border-b dark:border-gray-700/50">
                <h1 class="text-xl font-bold text-gray-900 dark:text-white flex items-center">
                    <span class="mr-2 text-2xl">üß†</span>
                    NOUS
                </h1>
                <div class="flex items-center space-x-2">
                    <!-- Theme Toggle -->
                    <button id="theme-toggle" type="button" aria-label="Toggle dark mode" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-brand dark:focus:ring-offset-gray-800 transition-colors">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.706-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464L6.464 5.05a1 1 0 00-1.414-1.414L3.636 5.05a1 1 0 001.414 1.414zm0 11.072a1 1 0 001.414 0l1.414-1.414a1 1 0 00-1.414-1.414l-1.414 1.414a1 1 0 000 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path></svg>
                    </button>
                    
                    <!-- Notification Center -->
                    <div class="relative">
                        <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-brand transition-colors" id="notification-btn">
                            <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
                            </svg>
                            <span class="absolute -top-1 -right-1 w-4 h-4 bg-brand text-white text-xs flex items-center justify-center rounded-full hidden" id="notification-badge">0</span>
                        </button>
                        <div class="absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-lg border dark:border-gray-700 z-50 hidden" id="notification-dropdown">
                            <div class="p-4 border-b dark:border-gray-700">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-semibold text-gray-900 dark:text-white">Notifications</h3>
                                    <button class="text-sm text-brand hover:text-brand-dark" id="mark-all-read">Mark all read</button>
                                </div>
                            </div>
                            <div class="max-h-64 overflow-y-auto" id="notification-list">
                                <div class="p-4 text-gray-500 text-center">No notifications</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="p-4 border-b dark:border-gray-700/50">
                <div class="relative">
                    <input type="text" id="global-search" placeholder="Search everything..." class="w-full px-4 py-2 pl-10 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-brand">
                    <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="absolute left-4 right-4 mt-1 bg-white dark:bg-gray-800 rounded-lg shadow-lg border dark:border-gray-700 z-50 hidden" id="search-results"></div>
            </div>
            
            <!-- Features Menu -->
            <div class="p-4 border-b dark:border-gray-700/50">
                <div class="space-y-2">
                    <a href="/api/v1/analytics/dashboard-view" class="flex items-center p-2 text-sm text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <span class="mr-3">üìä</span> Analytics Dashboard
                    </a>
                    <a href="/financial" class="flex items-center p-2 text-sm text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <span class="mr-3">üí∞</span> Financial Tracker
                    </a>
                    <a href="/family" class="flex items-center p-2 text-sm text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <span class="mr-3">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Family Dashboard
                    </a>
                    <a href="/goals" class="flex items-center p-2 text-sm text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <span class="mr-3">üéØ</span> Goals & Progress
                    </a>
                </div>
            </div>
            
            <!-- User Profile -->
            <div class="p-4 mt-auto border-t dark:border-gray-700/50">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-brand text-white flex items-center justify-center text-sm font-semibold mr-3">
                        {% if user.avatar %}
                            <img src="{{ user.avatar }}" alt="{{ user.name }}" class="w-full h-full rounded-full object-cover">
                        {% else %}
                            {{ user.name[0].upper() }}
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <h3 class="text-sm font-semibold text-gray-900 dark:text-white">{{ user.name }}</h3>
                        <a href="/" class="text-xs text-gray-500 dark:text-gray-400 hover:text-brand">‚Üê Home</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Chat Window -->
        <main class="flex-1 w-full flex flex-col h-screen">
            <header class="flex-shrink-0 h-16 px-4 flex items-center justify-between border-b dark:border-gray-700/50 bg-white dark:bg-gray-800">
                <div class="flex items-center">
                    <button id="back-to-conversations" aria-label="Back to conversations" class="p-2 mr-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none md:hidden transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <div class="w-10 h-10 rounded-full bg-brand text-white flex items-center justify-center text-sm font-semibold mr-3">
                        üß†
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">NOUS Assistant</h2>
                </div>
                
                <!-- Quick Actions -->
                <div class="flex items-center space-x-2">
                    <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none transition-colors" title="Voice features" onclick="alert('Voice features available with full setup')">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none transition-colors" title="Mindfulness" onclick="alert('Mindfulness features available with full setup')">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </div>
            </header>
            
            <div id="message-stream" role="log" aria-live="polite" class="flex-1 p-6 overflow-y-auto bg-gray-100 dark:bg-gray-900 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 dark:scrollbar-thumb-gray-600 dark:scrollbar-track-gray-900">
                <div class="flex flex-col space-y-4">
                    <!-- Welcome message -->
                    <div class="flex items-start justify-start animate-fade-in-up">
                        <div class="w-8 h-8 rounded-full mr-3 bg-brand flex items-center justify-center text-white text-sm font-semibold">
                            üß†
                        </div>
                        <div class="p-3 rounded-lg max-w-md shadow-sm bg-white dark:bg-gray-700">
                            <div class="text-sm">
                                <h3 class="font-semibold mb-2">Welcome to NOUS, {{ user.name }}! üëã</h3>
                                <p class="mb-2">I'm your intelligent personal assistant. I can help you with:</p>
                                <ul class="list-disc list-inside space-y-1 text-xs mb-2">
                                    <li>Answering questions on any topic</li>
                                    <li>Creative writing and brainstorming</li>
                                    <li>Problem-solving and analysis</li>
                                    <li>Learning and education</li>
                                    <li>Mental health support (CBT, DBT, AA)</li>
                                    <li>And much more!</li>
                                </ul>
                                <p>What would you like to explore today?</p>
                            </div>
                            <span class="text-xs mt-1 block text-right text-gray-500 dark:text-gray-400">Just now</span>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="p-4 border-t dark:border-gray-700/50 bg-white dark:bg-gray-800">
                <form id="message-form" class="flex items-center">
                    <label for="message-input" class="sr-only">Message</label>
                    <textarea 
                        id="message-input" 
                        name="message-input" 
                        class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-full bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-brand resize-none" 
                        placeholder="Type your message here..."
                        rows="1"
                        maxlength="2000"
                    ></textarea>
                    <button type="submit" aria-label="Send message" class="ml-3 flex-shrink-0 p-3 bg-brand text-white rounded-full hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                    </button>
                </form>
                
                <!-- Chat Actions -->
                <div class="flex items-center justify-between mt-2">
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        <span id="char-count">0</span>/2000 characters
                    </div>
                    <button type="button" class="text-xs text-gray-500 dark:text-gray-400 hover:text-brand transition-colors" id="clear-chat">
                        Clear Chat
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <!-- Quick Actions Floating Button -->
    <div class="fixed bottom-6 right-6 z-50">
        <div class="relative">
            <button id="fab-main" class="w-14 h-14 bg-brand text-white rounded-full shadow-lg hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2 transition-all duration-200 flex items-center justify-center">
                <span class="text-xl">‚ö°</span>
            </button>
            <div id="fab-menu" class="absolute bottom-16 right-0 space-y-2 hidden">
                <button class="fab-action flex items-center bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors whitespace-nowrap" data-action="new-task">
                    <span class="mr-2">‚úÖ</span> New Task
                </button>
                <button class="fab-action flex items-center bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors whitespace-nowrap" data-action="voice-note">
                    <span class="mr-2">üé§</span> Voice Note
                </button>
                <button class="fab-action flex items-center bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors whitespace-nowrap" data-action="quick-mood">
                    <span class="mr-2">üòä</span> Log Mood
                </button>
                <button class="fab-action flex items-center bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors whitespace-nowrap" data-action="new-goal">
                    <span class="mr-2">üéØ</span> New Goal
                </button>
                <button class="fab-action flex items-center bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors whitespace-nowrap" data-action="analytics">
                    <span class="mr-2">üìä</span> Analytics
                </button>
            </div>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div class="onboarding-overlay" id="onboarding-overlay" style="display: none;">
        <div class="onboarding-modal">
            <div class="onboarding-header">
                <h2>Welcome to NOUS! üß†</h2>
                <button class="close-onboarding" id="close-onboarding">√ó</button>
            </div>
            <div class="onboarding-content">
                <div class="onboarding-step" data-step="1">
                    <h3>üéØ Set Your Goals</h3>
                    <p>Start by setting some personal goals to track your progress.</p>
                    <button class="onboarding-btn" data-action="set-goals">Set Goals</button>
                </div>
                <div class="onboarding-step" data-step="2" style="display: none;">
                    <h3>üîç Discover Features</h3>
                    <p>Explore our powerful features for productivity, health, and life management.</p>
                    <button class="onboarding-btn" data-action="explore-features">Explore Features</button>
                </div>
                <div class="onboarding-step" data-step="3" style="display: none;">
                    <h3>‚ö° Quick Actions</h3>
                    <p>Use the floating action button for quick access to common tasks.</p>
                    <button class="onboarding-btn" data-action="finish-onboarding">Get Started</button>
                </div>
            </div>
            <div class="onboarding-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 33.33%;"></div>
                </div>
                <span class="progress-text">1 of 3</span>
            </div>
        </div>
    </div>

    <!-- Help System -->
    <div class="help-system" id="help-system">
        <button class="help-toggle" id="help-toggle">?</button>
        <div class="help-panel" id="help-panel" style="display: none;">
            <div class="help-header">
                <h3>Help & Shortcuts</h3>
                <button class="close-help" id="close-help">√ó</button>
            </div>
            <div class="help-content">
                <div class="help-section">
                    <h4>‚å®Ô∏è Keyboard Shortcuts</h4>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>/</kbd> <span>Open search</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>K</kbd> <span>Quick actions</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl</kbd> + <kbd>N</kbd> <span>New task</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Enter</kbd> <span>Send message</span>
                        </div>
                        <div class="shortcut-item">
                            <kbd>Shift</kbd> + <kbd>Enter</kbd> <span>New line</span>
                        </div>
                    </div>
                </div>
                <div class="help-section">
                    <h4>üéØ Quick Tips</h4>
                    <ul class="tips-list">
                        <li>Use natural language for all commands</li>
                        <li>Search across all your content with the search bar</li>
                        <li>Track your progress with the analytics dashboard</li>
                        <li>Set up goals to stay motivated</li>
                        <li>Use voice features for hands-free interaction</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // Initialize chat app with user data
        window.chatApp = new ChatApp({
            userName: {{ user.name | tojson }},
            userAvatar: {{ user.avatar | tojson }},
            apiEndpoint: '/api/v1/chat',
            userEndpoint: '/api/v1/user',
            legacyApiEndpoint: '/api/chat',  // Fallback support
            legacyUserEndpoint: '/api/user'
        });

        // Initialize enhanced features after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if (window.chatApp) {
                window.chatApp.initEnhancedFeatures();
            }
        });
    </script>
</body>
</html>