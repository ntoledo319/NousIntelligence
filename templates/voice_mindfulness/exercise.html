{% extends 'layout.html' %}

{% block title %}{{ exercise.name }} - Voice Mindfulness{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <a href="{{ url_for('voice_mindfulness.index') }}" class="btn btn-outline-secondary mb-3">
            <i class="fas fa-arrow-left me-2"></i> Back to Exercises
        </a>
        <h1 class="display-5 mb-3">
            <i class="fas fa-om text-primary me-2"></i> {{ exercise.name }}
        </h1>
        <p class="lead">{{ exercise.description }}</p>
        <div class="d-flex align-items-center mb-4">
            <span class="badge bg-info me-2">{{ exercise.duration }} minutes</span>
            {% if personalized %}
            <span class="badge bg-success me-2">Personalized</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Exercise player - mobile-friendly design -->
<div class="card shadow mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="exercise-script mb-4 p-3 bg-light rounded">
                    <p id="exerciseText" class="mb-0">{{ exercise.script }}</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center mb-3">
                    <span id="exerciseTimer" class="display-4 font-weight-bold">{{ exercise.duration }}:00</span>
                </div>
                <div class="d-grid gap-2">
                    <button id="startButton" class="btn btn-lg btn-primary">
                        <i class="fas fa-play me-2"></i> Start Voice Guidance
                    </button>
                    <button id="pauseButton" class="btn btn-lg btn-secondary d-none">
                        <i class="fas fa-pause me-2"></i> Pause
                    </button>
                    <button id="resumeButton" class="btn btn-lg btn-info d-none">
                        <i class="fas fa-play me-2"></i> Resume
                    </button>
                    <button id="stopButton" class="btn btn-lg btn-danger d-none">
                        <i class="fas fa-stop me-2"></i> Stop
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exercise completion form - only shown after exercise -->
<div id="completionForm" class="card shadow mb-4 d-none">
    <div class="card-header">
        <h5 class="mb-0">How was your experience?</h5>
    </div>
    <div class="card-body">
        <form action="{{ url_for('voice_mindfulness.log_completion') }}" method="post">
            <input type="hidden" name="exercise_name" value="{{ exercise.name }}">
            
            <div class="mb-3">
                <label class="form-label">How helpful was this exercise?</label>
                <div class="rating-stars d-flex justify-content-center fs-2 mb-3">
                    <i class="far fa-star rating-star" data-value="1"></i>
                    <i class="far fa-star rating-star" data-value="2"></i>
                    <i class="far fa-star rating-star" data-value="3"></i>
                    <i class="far fa-star rating-star" data-value="4"></i>
                    <i class="far fa-star rating-star" data-value="5"></i>
                </div>
                <input type="hidden" name="rating" id="ratingInput" value="">
            </div>
            
            <div class="d-grid">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-check-circle me-2"></i> Complete Exercise
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Tips for mindfulness practice -->
<div class="card bg-light mb-4">
    <div class="card-header">
        <h5 class="mb-0">Tips for Practice</h5>
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            <li class="list-group-item bg-transparent">
                <i class="fas fa-leaf text-success me-2"></i> Find a quiet space where you won't be disturbed
            </li>
            <li class="list-group-item bg-transparent">
                <i class="fas fa-couch text-success me-2"></i> Sit in a comfortable position
            </li>
            <li class="list-group-item bg-transparent">
                <i class="fas fa-mobile-alt text-success me-2"></i> Put your phone on silent mode
            </li>
            <li class="list-group-item bg-transparent">
                <i class="fas fa-hand-peace text-success me-2"></i> Be gentle with yourself - it's okay if your mind wanders
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const resumeButton = document.getElementById('resumeButton');
        const stopButton = document.getElementById('stopButton');
        const exerciseTimer = document.getElementById('exerciseTimer');
        const completionForm = document.getElementById('completionForm');
        const exerciseText = document.getElementById('exerciseText');
        const ratingInput = document.getElementById('ratingInput');
        const ratingStars = document.querySelectorAll('.rating-star');
        
        // Store exercise script
        const exerciseScript = `{{ exercise.script }}`;
        
        // Voice synthesis setup
        let speech = null;
        let timerInterval = null;
        let duration = {{ exercise.duration }} * 60; // convert to seconds
        let remainingTime = duration;
        let paused = false;
        
        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        // Update timer display
        function updateTimer() {
            if (!paused) {
                remainingTime--;
                exerciseTimer.textContent = formatTime(remainingTime);
                
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    completeExercise();
                }
            }
        }
        
        // Start the exercise
        function startExercise() {
            // Show the correct buttons
            startButton.classList.add('d-none');
            pauseButton.classList.remove('d-none');
            stopButton.classList.remove('d-none');
            
            // Start the timer
            timerInterval = setInterval(updateTimer, 1000);
            
            // Text-to-speech
            if ('speechSynthesis' in window) {
                speech = new SpeechSynthesisUtterance(exerciseScript);
                
                // Configure speech
                speech.rate = 0.9; // slightly slower
                speech.pitch = 1;
                
                // Use a calming voice if available
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    // Try to find a female voice for guided meditation
                    const femaleVoice = voices.find(voice => 
                        voice.name.includes('female') || 
                        voice.name.includes('woman') ||
                        voice.name.includes('girl'));
                    
                    if (femaleVoice) {
                        speech.voice = femaleVoice;
                    }
                }
                
                // Start speaking
                window.speechSynthesis.speak(speech);
                
                // When speech ends
                speech.onend = function() {
                    // Wait a bit then show the completion form
                    if (remainingTime <= 0) {
                        completeExercise();
                    }
                };
            } else {
                // Fallback for browsers without speech synthesis
                alert("Sorry, your browser doesn't support text-to-speech. Please read the exercise text.");
            }
        }
        
        // Pause the exercise
        function pauseExercise() {
            paused = true;
            
            // Show the correct buttons
            pauseButton.classList.add('d-none');
            resumeButton.classList.remove('d-none');
            
            // Pause speech
            if ('speechSynthesis' in window) {
                window.speechSynthesis.pause();
            }
        }
        
        // Resume the exercise
        function resumeExercise() {
            paused = false;
            
            // Show the correct buttons
            resumeButton.classList.add('d-none');
            pauseButton.classList.remove('d-none');
            
            // Resume speech
            if ('speechSynthesis' in window) {
                window.speechSynthesis.resume();
            }
        }
        
        // Stop the exercise
        function stopExercise() {
            clearInterval(timerInterval);
            
            // Stop speech
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            
            // Show completion form
            completeExercise();
        }
        
        // Complete exercise and show the form
        function completeExercise() {
            // Hide player controls
            startButton.classList.add('d-none');
            pauseButton.classList.add('d-none');
            resumeButton.classList.add('d-none');
            stopButton.classList.add('d-none');
            
            // Show completion form
            completionForm.classList.remove('d-none');
            
            // Scroll to the form
            completionForm.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Setup rating stars
        ratingStars.forEach(star => {
            star.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                ratingInput.value = value;
                
                // Update star appearance
                ratingStars.forEach(s => {
                    if (s.getAttribute('data-value') <= value) {
                        s.classList.remove('far');
                        s.classList.add('fas', 'text-warning');
                    } else {
                        s.classList.remove('fas', 'text-warning');
                        s.classList.add('far');
                    }
                });
            });
            
            // Hover effect
            star.addEventListener('mouseenter', function() {
                const value = this.getAttribute('data-value');
                ratingStars.forEach(s => {
                    if (s.getAttribute('data-value') <= value) {
                        s.classList.add('text-warning');
                    }
                });
            });
            
            star.addEventListener('mouseleave', function() {
                // Only keep the stars filled based on actual selection
                if (!ratingInput.value) {
                    ratingStars.forEach(s => {
                        s.classList.remove('text-warning');
                    });
                } else {
                    ratingStars.forEach(s => {
                        if (s.getAttribute('data-value') <= ratingInput.value) {
                            s.classList.add('text-warning');
                        } else {
                            s.classList.remove('text-warning');
                        }
                    });
                }
            });
        });
        
        // Event listeners
        startButton.addEventListener('click', startExercise);
        pauseButton.addEventListener('click', pauseExercise);
        resumeButton.addEventListener('click', resumeExercise);
        stopButton.addEventListener('click', stopExercise);
    });
</script>

<style>
    .exercise-script {
        font-size: 1.1rem;
        line-height: 1.7;
    }
    
    .rating-stars {
        cursor: pointer;
    }
    
    .rating-star {
        padding: 0 5px;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
        #exerciseTimer {
            font-size: 2.5rem;
        }
        
        .exercise-script {
            font-size: 1rem;
            line-height: 1.5;
        }
    }
</style>
{% endblock %}