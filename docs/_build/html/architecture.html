<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Architecture - NOUS Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: #fafafa;
        }
        
        .content {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 0.5rem;
            margin-top: 0;
        }
        
        h2 {
            color: #1e40af;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 0.3rem;
            margin-top: 2rem;
        }
        
        h3 {
            color: #1f2937;
            margin-top: 1.5rem;
        }
        
        code {
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
        }
        
        pre {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
        }
        
        pre code {
            background: none;
            padding: 0;
        }
        
        p {
            margin: 1rem 0;
        }
        
        strong {
            color: #374151;
            font-weight: 600;
        }
        
        em {
            color: #6b7280;
            font-style: italic;
        }
        
        .navigation {
            background: #2563eb;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .navigation a {
            color: white;
            text-decoration: none;
            margin-right: 1rem;
        }
        
        .navigation a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="navigation">
        <a href="index.html">Home</a>
        <a href="overview.html">Overview</a>
        <a href="installation.html">Installation</a>
        <a href="api_reference.html">API Reference</a>
        <a href="architecture.html">Architecture</a>
        <a href="development.html">Development</a>
        <a href="deployment.html">Deployment</a>
        <a href="troubleshooting.html">Troubleshooting</a>
        <a href="changelog.html">Changelog</a>
    </div>
    
    <div class="content">
        <h1>System Architecture</h1>
<br>
<p>This document provides an in-depth analysis of NOUS Personal Assistant's system architecture, design patterns, and implementation strategies.</p>
<br>
<h2>Architectural Overview</h2>
<br>
<p>NOUS follows a layered monolithic architecture optimized for simplicity, maintainability, and cost-effectiveness while providing enterprise-grade features.</p>
<br>
<pre><code>

┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                    │
│  ┌─────────────────┐  ┌─────────────────┐ ┌──────────┐  │
│  │   Landing Page  │  │   Chat Interface │ │ Admin UI │  │
│  │  (Public Access)│  │ (Authenticated) │ │(Admin)   │  │
│  └─────────────────┘  └─────────────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                   Application Layer                     │
│  ┌─────────────────┐  ┌─────────────────┐ ┌──────────┐  │
│  │  Flask Router   │  │ Authentication  │ │Middleware│  │
│  │   (Routes)      │  │   (OAuth)       │ │(ProxyFix)│  │
│  └─────────────────┘  └─────────────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                    Business Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐ ┌──────────┐  │
│  │  Chat Handler   │  │  Health Monitor │ │Beta Mgmt │  │
│  │  (AI Integration│  │ (System Status) │ │(Features)│  │
│  └─────────────────┘  └─────────────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                     Data Layer                          │
│  ┌─────────────────┐  ┌─────────────────┐ ┌──────────┐  │
│  │   SQLAlchemy    │  │   File Storage  │ │  Cache   │  │
│  │  (PostgreSQL)   │  │   (Sessions)    │ │(Memory)  │  │
│  └─────────────────┘  └─────────────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                  External Services                      │
│  ┌─────────────────┐  ┌─────────────────┐ ┌──────────┐  │
│  │   OpenRouter    │  │  HuggingFace    │ │Google    │  │
│  │   (AI Models)   │  │  (Free AI)      │ │(OAuth)   │  │
│  └─────────────────┘  └─────────────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘

</code></pre>
<h2>Core Design Principles</h2>
<br>
<h3>Single Responsibility Principle</h3>
<br>
<p>Each component has a clearly defined purpose:</p>
<br>
<em> <strong>main.py<strong>: Application entry point and launcher
<em> <strong>app.py<strong>: Flask application configuration and initialization
<em> <strong>models/<strong>: Database schema and ORM models
<em> <strong>routes/<strong>: HTTP request handlers and routing logic
<em> <strong>utils/<strong>: Utility functions and helper classes
<em> <strong>api/<strong>: RESTful API endpoints and serialization
<br>
<h3>Fail-Safe Design</h3>
<br>
<p>The system is designed to gracefully handle failures:</p>
<br>
<em> <strong>Database Disconnection<strong>: Automatic reconnection with exponential backoff
<em> <strong>External API Failures<strong>: Fallback responses and error handling
<em> <strong>Authentication Issues<strong>: Graceful degradation to public mode
<em> <strong>Resource Exhaustion<strong>: Rate limiting and resource monitoring
<br>
<h3>Cost Optimization</h3>
<br>
<p>Strategic architectural decisions minimize operational costs:</p>
<br>
<em> <strong>AI Provider Selection<strong>: Free tier HuggingFace + low-cost OpenRouter
<em> <strong>Database Strategy<strong>: Efficient connection pooling and query optimization
<em> <strong>Caching Strategy<strong>: In-memory caching for frequently accessed data
<em> <strong>Resource Management<strong>: Optimized for Replit's resource constraints
<br>
<h2>Application Structure</h2>
<br>
<h3>Directory Organization</h3>
<br>
<pre><code>

nous-personal-assistant/
├── main.py                    # Application launcher
├── app.py                     # Main Flask application
├── models/                    # Database models
│   ├── __init__.py
│   ├── user.py               # User authentication model
│   └── beta_models.py        # Beta testing models
├── routes/                    # Route handlers
│   ├── __init__.py
│   ├── main.py               # Public routes
│   ├── api.py                # API endpoints
│   └── beta_admin.py         # Admin interface
├── utils/                     # Utility modules
│   ├── __init__.py
│   ├── health_monitor.py     # System health monitoring
│   ├── database_optimizer.py # Database performance
│   └── cost_optimized_ai.py  # AI provider interface
├── api/                       # Chat API system
│   ├── __init__.py
│   └── chat.py               # Chat dispatcher
├── templates/                 # Jinja2 templates
│   ├── base.html             # Base template
│   ├── landing.html          # Public landing page
│   ├── app.html              # Chat interface
│   └── admin/                # Admin templates
├── static/                    # Static assets
│   ├── styles.css            # Application CSS
│   ├── app.js                # Frontend JavaScript
│   └── service-worker.js     # PWA functionality
├── docs/                      # Documentation
│   ├── conf.py               # Sphinx configuration
│   └── *.rst                 # Documentation files
└── tests/                     # Test suites
    ├── test_app.py           # Application tests
    └── test_api.py           # API tests

</code></pre>
<h3>Module Dependencies</h3>
<br>
<pre><code>

main.py
└── app.py
    ├── models/
    │   ├── user.py
    │   └── beta_models.py
    ├── routes/
    │   ├── main.py
    │   ├── api.py
    │   └── beta_admin.py
    ├── utils/
    │   ├── health_monitor.py
    │   ├── database_optimizer.py
    │   └── cost_optimized_ai.py
    └── api/
        └── chat.py

</code></pre>
<h2>Data Architecture</h2>
<br>
<h3>Database Schema</h3>
<br>
<strong>User Management:<strong>
<br>
<pre><code>

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255),
    google_id VARCHAR(255) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

</code></pre>
<strong>Beta Testing:<strong>
<br>
<pre><code>

CREATE TABLE feature_flags (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    enabled BOOLEAN DEFAULT FALSE,
    rollout_percentage INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_feedback (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    feedback_type VARCHAR(50),
    message TEXT,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

</code></pre>
<strong>Session Management:<strong>
<br>
<pre><code>

CREATE TABLE sessions (
    id VARCHAR(255) PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    data JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP
);

</code></pre>
<h3>Connection Management</h3>
<br>
<p>SQLAlchemy configuration optimized for Replit:</p>
<br>
<pre><code>

app.config["SQLALCHEMY_ENGINE_OPTIONS"] = {
    "pool_size": 2,                 # Small pool for resource efficiency
    "max_overflow": 10,             # Handle traffic spikes
    "pool_recycle": 3600,           # Prevent stale connections
    "pool_pre_ping": True,          # Validate connections
    "connect_args": {
        "options": "-c timezone=utc"  # Consistent timezone
    }
}

</code></pre>
<h3>Query Optimization</h3>
<br>
<p>Database queries are optimized for performance:</p>
<br>
<em> <strong>Indexed Lookups<strong>: Primary keys and foreign keys indexed
<em> <strong>Query Batching<strong>: Bulk operations where possible
<em> <strong>Connection Pooling<strong>: Reused connections for efficiency
<em> <strong>Prepared Statements<strong>: SQLAlchemy automatic parameterization
<br>
<h2>Authentication Architecture</h2>
<br>
<h3>OAuth 2.0 Implementation</h3>
<br>
<p>Google OAuth integration follows standard OAuth 2.0 flow:</p>
<br>
<p>1. <strong>Authorization Request<strong></p>
<br>
<pre><code>
   
   @app.route('/login')
   def login():
       authorization_url, state = google.authorization_url(
           'https://accounts.google.com/o/oauth2/auth',
           access_type="online",
           prompt="select_account"
       )
       session['oauth_state'] = state
       return redirect(authorization_url)

</code></pre>
<p>2. <strong>Authorization Callback<strong></p>
<br>
<pre><code>
   
   @app.route('/oauth/callback')
   def oauth_callback():
       token = google.fetch_token(
           'https://oauth2.googleapis.com/token',
           authorization_response=request.url,
           state=session.get('oauth_state')
       )
       user_info = google.get('https://www.googleapis.com/userinfo/v2/me')
       # Create or update user session

</code></pre>
<h3>Session Management</h3>
<br>
<p>Session security configuration:</p>
<br>
<pre><code>

app.config.update(
    SESSION_COOKIE_SECURE=True,      # HTTPS only in production
    SESSION_COOKIE_HTTPONLY=True,    # No JavaScript access
    SESSION_COOKIE_SAMESITE='Lax',   # CSRF protection
    PERMANENT_SESSION_LIFETIME=timedelta(days=30)
)

</code></pre>
<h3>Permission System</h3>
<br>
<p>Role-based access control:</p>
<br>
<pre><code>

def require_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not session.get('user_id'):
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

def require_admin(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        user_email = session.get('user_email')
        if user_email != 'toledonick98@gmail.com':
            abort(403)
        return f(*args, **kwargs)
    return decorated_function

</code></pre>
<h2>API Architecture</h2>
<br>
<h3>RESTful Design</h3>
<br>
<p>API endpoints follow REST conventions:</p>
<br>
<pre><code>

GET    /api/user                 # Get current user
POST   /api/chat                 # Send chat message
GET    /api/health               # System health
GET    /api/beta/flags           # List feature flags
PUT    /api/beta/flags/{id}      # Update feature flag
POST   /api/feedback             # Submit feedback

</code></pre>
<h3>Response Format</h3>
<br>
<p>Standardized JSON responses:</p>
<br>
<pre><code>

# Success response
{
    "data": {...},
    "status": "success",
    "timestamp": "2025-06-27T12:00:00Z"
}

# Error response
{
    "error": {
        "code": "ERROR_CODE",
        "message": "Human readable message",
        "details": "Technical details"
    },
    "status": "error",
    "timestamp": "2025-06-27T12:00:00Z"
}

</code></pre>
<h3>Error Handling</h3>
<br>
<p>Comprehensive error handling strategy:</p>
<br>
<pre><code>

@app.errorhandler(404)
def not_found(error):
    if request.path.startswith('/api/'):
        return jsonify({
            "error": {
                "code": "NOT_FOUND",
                "message": "Resource not found"
            },
            "status": "error"
        }), 404
    return render_template('404.html'), 404

</code></pre>
<h2>Chat System Architecture</h2>
<br>
<h3>Intent-Based Routing</h3>
<br>
<p>Chat messages are routed based on intent patterns:</p>
<br>
<pre><code>

class ChatDispatcher:
    def __init__(self):
        self.handlers = {}
        self.auto_discover_handlers()
    
    async def dispatch(self, message: str, context: Dict) -> Dict:
        intent = self.classify_intent(message)
        handler = self.get_handler(intent)
        return await handler(message, context)

</code></pre>
<h3>Handler Registration</h3>
<br>
<p>Automatic handler discovery and registration:</p>
<br>
<pre><code>

def register_chat_handler(intent_patterns: list, handler_func):
    """Register a chat handler for specific intent patterns"""
    for pattern in intent_patterns:
        CHAT_HANDLERS[pattern] = handler_func

# Example handler
@register_chat_handler(['weather', 'forecast', 'temperature'])
def handle_weather_query(message: str, context: Dict) -> Dict:
    location = extract_location(message)
    weather_data = get_weather(location)
    return format_weather_response(weather_data)

</code></pre>
<h3>AI Provider Integration</h3>
<br>
<p>Unified provider interface with fallbacks:</p>
<br>
<pre><code>

class AIProviderManager:
    def __init__(self):
        self.providers = [
            OpenRouterProvider(),
            HuggingFaceProvider(),
            FallbackProvider()
        ]
    
    async def generate_response(self, prompt: str) -> str:
        for provider in self.providers:
            try:
                return await provider.generate(prompt)
            except Exception as e:
                logging.warning(f"Provider {provider} failed: {e}")
        raise Exception("All AI providers failed")

</code></pre>
<h2>Health Monitoring Architecture</h2>
<br>
<h3>Multi-Level Health Checks</h3>
<br>
<pre><code>

class HealthMonitor:
    def __init__(self):
        self.checks = [
            DatabaseHealthCheck(),
            ExternalServiceHealthCheck(),
            SystemResourceHealthCheck()
        ]
    
    def get_health_status(self) -> Dict:
        results = {}
        overall_status = "healthy"
        
        for check in self.checks:
            try:
                result = check.perform_check()
                results[check.name] = result
                if result['status'] != 'healthy':
                    overall_status = 'degraded'
            except Exception as e:
                results[check.name] = {
                    'status': 'unhealthy',
                    'error': str(e)
                }
                overall_status = 'unhealthy'
        
        return {
            'overall_status': overall_status,
            'checks': results,
            'timestamp': datetime.utcnow().isoformat()
        }

</code></pre>
<h3>Performance Monitoring</h3>
<br>
<p>Real-time performance metrics:</p>
<br>
<pre><code>

@app.before_request
def before_request():
    g.start_time = time.time()

@app.after_request
def after_request(response):
    duration = time.time() - g.start_time
    if duration > 1.0:  # Log slow requests
        logging.warning(f"Slow request: {request.path} took {duration:.2f}s")
    return response

</code></pre>
<h2>Beta Testing Architecture</h2>
<br>
<h3>Feature Flag System</h3>
<br>
<p>Database-driven feature flags:</p>
<br>
<pre><code>

class FeatureFlagManager:
    def is_enabled(self, flag_name: str, user_id: int = None) -> bool:
        flag = FeatureFlag.query.filter_by(name=flag_name).first()
        if not flag or not flag.enabled:
            return False
        
        if flag.rollout_percentage == 100:
            return True
        
        if user_id:
            # Consistent user-based rollout
            user_hash = hash(f"{flag_name}:{user_id}") % 100
            return user_hash < flag.rollout_percentage
        
        return random.randint(0, 99) < flag.rollout_percentage

</code></pre>
<h3>User Segmentation</h3>
<br>
<p>Targeted feature rollouts:</p>
<br>
<pre><code>

def check_feature_access(flag_name: str, user: User) -> bool:
    flag = FeatureFlag.query.filter_by(name=flag_name).first()
    
    # Check user segments
    if flag.target_segments:
        user_segment = determine_user_segment(user)
        if user_segment not in flag.target_segments:
            return False
    
    # Check rollout percentage
    return flag_manager.is_enabled(flag_name, user.id)

</code></pre>
<h2>Deployment Architecture</h2>
<br>
<h3>Replit Optimization</h3>
<br>
<p>Configuration optimized for Replit Cloud:</p>
<br>
<pre><code>

# replit.toml
run = ["python3", "main.py"]

[deployment]
run = ["python3", "main.py"]
deploymentTarget = "cloudrun"

[env]
PORT = "5000"
PUBLIC_MODE = "true"

[auth]
pageEnabled = false
buttonEnabled = false

</code></pre>
<h3>ProxyFix Configuration</h3>
<br>
<p>Proper proxy handling for Replit:</p>
<br>
<pre><code>

from werkzeug.middleware.proxy_fix import ProxyFix

app.wsgi_app = ProxyFix(
    app.wsgi_app, 
    x_for=1,     # Trust 1 proxy for X-Forwarded-For
    x_proto=1,   # Trust 1 proxy for X-Forwarded-Proto
    x_host=1,    # Trust 1 proxy for X-Forwarded-Host
    x_port=1     # Trust 1 proxy for X-Forwarded-Port
)

</code></pre>
<h2>Security Architecture</h2>
<br>
<h3>Defense in Depth</h3>
<br>
<p>Multiple security layers:</p>
<br>
<p>1. <strong>Transport Security<strong>: HTTPS/TLS encryption</p>
<p>2. <strong>Authentication<strong>: OAuth 2.0 with Google</p>
<p>3. <strong>Session Security<strong>: Secure cookie configuration</p>
<p>4. <strong>Input Validation<strong>: Form validation and sanitization</p>
<p>5. <strong>CSRF Protection<strong>: Token-based CSRF prevention</p>
<p>6. <strong>Rate Limiting<strong>: Request throttling</p>
<p>7. <strong>Error Handling<strong>: Secure error responses</p>
<br>
<h3>Security Headers</h3>
<br>
<p>Comprehensive security header configuration:</p>
<br>
<pre><code>

@app.after_request
def add_security_headers(response):
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    response.headers['Strict-Transport-Security'] = 'max-age=31536000; includeSubDomains'
    response.headers['Content-Security-Policy'] = "default-src 'self'"
    return response

</code></pre>
<h2>Future Architecture Considerations</h2>
<br>
<h3>Microservices Migration</h3>
<br>
<p>Potential service decomposition:</p>
<br>
<em> <strong>Authentication Service<strong>: User management and OAuth
<em> <strong>Chat Service<strong>: AI integration and conversation handling
<em> <strong>Analytics Service<strong>: User behavior and system metrics
<em> <strong>Admin Service<strong>: Beta management and system administration
<br>
<h3>Caching Strategy</h3>
<br>
<p>Redis integration for improved performance:</p>
<br>
<em> <strong>Session Storage<strong>: Distributed session management
<em> <strong>API Response Caching<strong>: Frequently accessed data
<em> <strong>Rate Limiting<strong>: Distributed rate limiting counters
<em> <strong>Feature Flag Caching<strong>: Reduce database queries
<br>
<h3>Event-Driven Architecture</h3>
<br>
<p>Webhook and event system:</p>
<br>
<em> <strong>User Events<strong>: Registration, login, feature usage
<em> <strong>System Events<strong>: Health changes, errors, deployments
<em> <strong>External Events<strong>: API webhooks, scheduled tasks
<em> <strong>Analytics Events<strong>: User interaction tracking
<br>
<p>This comprehensive architecture documentation provides the foundation for understanding, maintaining, and extending the NOUS Personal Assistant system.</p>
    </div>
</body>
</html>