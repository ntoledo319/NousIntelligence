#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Get the current branch name
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Skip checks for main branch (handled by CI)
if [ "$CURRENT_BRANCH" = "main" ]; then
  echo "âš ï¸  Skipping pre-push checks for main branch (handled by CI)"
  exit 0
fi

# Function to run a command with a spinner
run_with_spinner() {
  local pid=""
  local msg="$1"
  shift
  
  # Start the command in the background
  "$@" >/dev/null 2>&1 &
  pid=$!
  
  # Display spinner while the command runs
  local spin='â£¾â£½â£»â¢¿â¡¿â£Ÿâ£¯â£·'
  local i=0
  while kill -0 $pid 2>/dev/null; do
    i=$(( (i+1) % 8 ))
    printf "\r${spin:$i:1} ${msg}...  "
    sleep 0.1
  done
  
  # Wait for the command to complete and get the exit status
  wait $pid
  local exit_status=$?
  
  # Clear the line
  printf "\r%-50s\n" "${msg}..."
  
  return $exit_status
}

# Run linter
run_with_spinner "ğŸ” Running ESLint" npx eslint . --ext .js,.jsx,.ts,.tsx
if [ $? -ne 0 ]; then
  echo "âŒ ESLint check failed. Please fix the errors and try again."
  exit 1
fi

# Run type checking
run_with_spinner "ğŸ” Type checking" npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript check failed. Please fix the errors and try again."
  exit 1
fi

# Run tests
run_with_spinner "ğŸ§ª Running tests" npx jest --passWithNoTests
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix the failing tests and try again."
  exit 1
fi

echo "âœ… All checks passed! Pushing to remote..."
