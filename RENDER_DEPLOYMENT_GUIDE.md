# NOUS Intelligence - Render Deployment Guide

## ðŸš€ Complete Production Deployment Guide for Render.com

This guide provides step-by-step instructions for deploying the NOUS Intelligence Platform to Render.com with optimal performance, security, and scalability.

---

## Prerequisites

Before deploying to Render, ensure you have:

1. **GitHub Account**: Your repository should be pushed to GitHub
2. **Render Account**: Sign up at [render.com](https://render.com)
3. **Google OAuth Credentials**: From [Google Cloud Console](https://console.cloud.google.com)
4. **Domain Name** (Optional): For custom domain configuration

---

## Quick Deploy (5 Minutes)

### Step 1: Prepare Your Repository

```bash
# Ensure all changes are committed
git add .
git commit -m "Prepare for Render deployment"
git push origin main
```

### Step 2: Deploy Using Blueprint

1. **Log in to Render Dashboard**: https://dashboard.render.com
2. **Click "New" â†’ "Blueprint"**
3. **Connect Your GitHub Repository**
4. **Select the Repository**: `NousIntelligence`
5. **Click "Apply"**

Render will automatically:
- Create a PostgreSQL database
- Deploy the web service
- Set up environment variables
- Configure health checks

### Step 3: Configure Google OAuth

1. **Go to Google Cloud Console**: https://console.cloud.google.com
2. **Navigate to**: APIs & Services â†’ Credentials
3. **Add Authorized Redirect URI**:
   ```
   https://nous-intelligence-web.onrender.com/callback/google
   ```
4. **Copy Your Credentials**:
   - Client ID
   - Client Secret

### Step 4: Set Environment Variables in Render

1. **Go to Your Web Service** in Render Dashboard
2. **Navigate to**: Environment Tab
3. **Add the Following**:
   ```
   GOOGLE_CLIENT_ID=your-google-client-id
   GOOGLE_CLIENT_SECRET=your-google-client-secret
   ```

### Step 5: Deploy!

Click **"Manual Deploy" â†’ "Deploy latest commit"**

Your application will be live at: `https://nous-intelligence-web.onrender.com`

---

## Detailed Configuration

### Environment Variables

#### Required Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `GOOGLE_CLIENT_ID` | Google OAuth Client ID | `123456789-abc.apps.googleusercontent.com` |
| `GOOGLE_CLIENT_SECRET` | Google OAuth Client Secret | `GOCSPX-xxxxxxxxxxxxxxxx` |
| `SESSION_SECRET` | Auto-generated by Render | (Auto-generated) |
| `DATABASE_URL` | Auto-set by Render | (Auto-generated) |

#### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `APP_URL` | Application URL | `https://nous-intelligence-web.onrender.com` |
| `OAUTH_REDIRECT_URI` | OAuth callback URL | `{APP_URL}/callback/google` |
| `LOG_LEVEL` | Logging level | `INFO` |
| `FLASK_ENV` | Flask environment | `production` |
| `REDIS_URL` | Redis URL for caching/rate limiting | (Optional) |
| `CORS_ALLOWED_ORIGINS` | Comma-separated origins | (Auto-configured) |

### Database Configuration

The PostgreSQL database is automatically created with:
- **Plan**: Starter (Free tier available)
- **Region**: Same as web service
- **Connection**: Automatic via `DATABASE_URL`

**Connection Pool Settings** (already configured in code):
- Pool size: 10 connections
- Max overflow: 20 additional connections
- Connection timeout: 30 seconds
- Pool recycle: 5 minutes

### Performance Optimization

#### Worker Configuration

The `gunicorn.conf.py` automatically configures:
- **Workers**: `(CPU cores * 2) + 1`
- **Worker Class**: `sync`
- **Timeout**: 60 seconds
- **Max Requests**: 1000 (worker auto-restart)

For Render's **Starter Plan** (0.5 CPU):
- Approximately 2 workers

For **Standard Plan** (1 CPU):
- Approximately 3 workers

#### Caching Strategy

**Session Storage**:
- Default: Server-side session storage
- Optional: Redis for distributed sessions

**API Response Caching**:
- Implemented via Flask-Limiter with Redis backend
- Falls back to in-memory if Redis unavailable

---

## Security Configuration

### HTTPS/TLS

âœ… **Automatically Enabled**: Render provides free SSL/TLS certificates

### Security Headers

Automatically configured via `utils/security_middleware.py`:
- âœ… HSTS (Strict-Transport-Security)
- âœ… X-Content-Type-Options: nosniff
- âœ… X-Frame-Options: SAMEORIGIN
- âœ… Content-Security-Policy
- âœ… Permissions-Policy
- âœ… Referrer-Policy

### CORS Configuration

Configured via `utils/production_security.py`:
- **Allowed Origins**: Render domain + localhost (dev)
- **Credentials**: Enabled for authentication
- **Methods**: GET, POST, PUT, DELETE, OPTIONS
- **Max Age**: 1 hour (preflight cache)

### Rate Limiting

**Authentication Endpoints**:
- Google login: 5 requests/minute
- OAuth callback: 10 requests/hour

**API Endpoints**:
- General: 200 requests/hour, 50/minute
- Health check: Unlimited (no rate limit)

**Storage**:
- Production: Redis (recommended)
- Fallback: In-memory (single instance)

---

## Monitoring & Health Checks

### Health Check Endpoint

**URL**: `/api/health`

**Response** (200 OK):
```json
{
  "status": "thriving",
  "emotional_state": "balanced and present",
  "timestamp": "2025-12-25T10:00:00.000Z",
  "version": "1.0.0-healing",
  "database": "connected and secure",
  "affirmation": "You are valued",
  "system_wellness": {
    "cpu_state": "peacefully processing",
    "memory_state": "holding space gracefully",
    "uptime": "persistently present"
  },
  "message": "NOUS is here for you, always. ðŸ’š"
}
```

### Render Configuration

In `render.yaml`:
```yaml
healthCheckPath: /api/health
```

Render will:
- Check health every 30 seconds
- Mark service unhealthy after 3 failures
- Auto-restart unhealthy services

### Logging

**Production Logging** (`utils/production_logging.py`):
- **Format**: JSON structured logs
- **Fields**: timestamp, level, request_id, path, method, duration
- **Output**: stdout (viewable in Render dashboard)

**View Logs**:
1. Render Dashboard â†’ Your Service
2. Logs Tab
3. Filter by level, search by request_id

---

## Troubleshooting

### Common Issues

#### 1. OAuth Redirect Mismatch

**Error**: `redirect_uri_mismatch`

**Solution**:
1. Go to Google Cloud Console â†’ Credentials
2. Ensure redirect URI exactly matches:
   ```
   https://nous-intelligence-web.onrender.com/callback/google
   ```
3. No trailing slashes!
4. Wait 5 minutes for Google to propagate changes

#### 2. Database Connection Issues

**Error**: `could not connect to server`

**Solution**:
1. Check `DATABASE_URL` is set (Render auto-sets this)
2. Verify database is in same region as web service
3. Check database status in Render dashboard
4. Review logs for specific connection errors

#### 3. Import Errors

**Error**: `ModuleNotFoundError`

**Solution**:
1. Ensure `pyproject.toml` has all dependencies
2. Build command should be: `pip install -e .`
3. Check build logs for installation errors
4. Verify Python version matches: 3.11

#### 4. Rate Limiting Not Working

**Issue**: Rate limiting falls back to in-memory

**Solution** (Optional - Add Redis):
1. Render Dashboard â†’ New â†’ Redis
2. Copy Redis URL
3. Add environment variable: `REDIS_URL=<your-redis-url>`
4. Redeploy service

#### 5. Performance Issues

**Symptoms**: Slow response times, timeouts

**Solutions**:
- Upgrade to Standard plan (more CPU/memory)
- Enable Redis for caching and sessions
- Review slow query logs in database dashboard
- Check worker count in logs (should scale with CPU)

---

## Scaling Guide

### Vertical Scaling (Increase Resources)

**Starter â†’ Standard**:
- CPU: 0.5 â†’ 1.0
- RAM: 512MB â†’ 2GB
- Workers: ~2 â†’ ~3

**Standard â†’ Pro**:
- CPU: 1.0 â†’ 2.0
- RAM: 2GB â†’ 4GB
- Workers: ~3 â†’ ~5

**Cost**: ~$7/month (Starter) â†’ $25/month (Standard)

### Horizontal Scaling

Currently configured for **single instance** deployment.

For multi-instance:
1. **Add Redis** (required for shared sessions)
2. **Enable Auto-Scaling** in Render dashboard
3. **Configure**: Min instances: 1, Max instances: 3

### Database Scaling

**Free â†’ Starter**:
- Storage: 256MB â†’ 1GB
- Connections: 20 â†’ 50

**Starter â†’ Standard**:
- Storage: 1GB â†’ 10GB
- Connections: 50 â†’ 100
- Performance: ~3x faster

---

## Production Checklist

Before going live, verify:

- [ ] Google OAuth credentials configured
- [ ] All environment variables set
- [ ] Health check endpoint responding (200 OK)
- [ ] HTTPS enabled (automatic on Render)
- [ ] Database connected successfully
- [ ] Logs showing no errors
- [ ] Test user login flow
- [ ] Test API endpoints
- [ ] Review security headers (use securityheaders.com)
- [ ] Configure custom domain (optional)
- [ ] Set up monitoring alerts (Render dashboard)
- [ ] Document API keys in secure location
- [ ] Test rate limiting (optional)

---

## Advanced Configuration

### Custom Domain

1. **Render Dashboard** â†’ Your Service â†’ Settings
2. **Add Custom Domain**: `app.yourdomain.com`
3. **Add DNS Records** (at your DNS provider):
   ```
   Type: CNAME
   Name: app
   Value: nous-intelligence-web.onrender.com
   ```
4. **Update OAuth Redirect**:
   ```
   https://app.yourdomain.com/callback/google
   ```

### Redis Cache (Optional)

**Benefits**:
- Distributed rate limiting
- Session storage (multi-instance)
- API response caching
- Better performance

**Setup**:
1. Render Dashboard â†’ New â†’ Redis
2. Add to environment: `REDIS_URL`
3. Restart web service

### Background Jobs (Optional)

For scheduled tasks:
1. Add `scheduler` optional dependency
2. Configure in `services/scheduler_service.py`
3. Or use Render Cron Jobs for separate workers

---

## Cost Optimization

### Free Tier Strategy

**Free Resources** (Render):
- PostgreSQL: 256MB (90 days free)
- Web Service: Spins down after 15 min inactivity
- HTTPS/SSL: Free
- Automatic deployments: Free

**Cost**: $0/month (with limitations)

### Production Strategy

**Recommended Setup**:
- Web Service: Starter ($7/month)
- PostgreSQL: Starter ($7/month)
- Redis (optional): Starter ($10/month)

**Total**: $14-24/month for 24/7 uptime

### Cost vs. Performance

| Plan | Monthly Cost | Users Supported | Response Time |
|------|--------------|-----------------|---------------|
| Free | $0 | 10-50 | 2-5s (cold start) |
| Starter | $7 | 100-500 | <1s |
| Standard | $25 | 1000-5000 | <500ms |

---

## Support & Resources

### Render Documentation
- [Render Docs](https://render.com/docs)
- [Deploy Flask App](https://render.com/docs/deploy-flask)
- [PostgreSQL](https://render.com/docs/databases)

### NOUS Resources
- [Main README](README.md)
- [Environment Variables](ENV_VARS.md)
- [OAuth Setup](OAUTH_SETUP.md)
- [Security](SECURITY.md)

### Getting Help

**Render Support**:
- Dashboard â†’ Help & Support
- Community: https://community.render.com

**NOUS Issues**:
- GitHub Issues: https://github.com/ntoledo319/NousIntelligence/issues

---

## Next Steps

After successful deployment:

1. **Monitor Performance**
   - Review Render metrics dashboard
   - Check response times and error rates
   - Monitor database connections

2. **Set Up Alerts**
   - Render â†’ Service â†’ Notifications
   - Email alerts for downtime
   - Slack/Discord webhooks

3. **Optimize Based on Usage**
   - Review logs for slow endpoints
   - Add caching where beneficial
   - Scale resources as needed

4. **Regular Maintenance**
   - Update dependencies monthly
   - Review security advisories
   - Backup database regularly
   - Test disaster recovery

---

## Success Metrics

Your deployment is successful when:

âœ… Health check returns 200 OK
âœ… Users can log in via Google OAuth
âœ… API endpoints respond < 1 second
âœ… No errors in logs (past 24h)
âœ… Database connection stable
âœ… SSL/HTTPS active
âœ… Security headers configured
âœ… Rate limiting active
âœ… Uptime > 99.5%

---

**Congratulations!** ðŸŽ‰

Your NOUS Intelligence Platform is now running in production on Render with enterprise-grade security, performance, and scalability.

---

*Last updated: 2025-12-25*
*NOUS Intelligence Platform v1.0*
