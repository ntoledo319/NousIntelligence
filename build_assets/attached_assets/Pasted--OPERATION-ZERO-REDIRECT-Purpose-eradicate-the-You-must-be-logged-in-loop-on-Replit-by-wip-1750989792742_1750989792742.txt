üí£  OPERATION ZERO-REDIRECT  üí£
Purpose: eradicate the ‚ÄúYou must be logged in‚Äù loop on Replit by wiping the codebase (except `.replit` and Git history) and rebuilding a minimal, proxy-aware, cookie-secure stack with ONE backend, ONE UI, ONE workflow, and a smoke-test gate that blocks any future redirect regressions.
NOTE: The Agent **cannot edit `.replit`**; everything is done in new code files that obey its current `run` command.

================================================================================
GLOBAL RULES
--------------------------------------------------------------------------------
1. Keep only `.replit`, `.git`, and `.gitignore`; everything else is recreated.
2. Never hard-code secrets‚Äîread them from Replit **Secrets**.
3. Comment every non-obvious choice.
4. Abort commit if smoke tests fail.

================================================================================
PHASE 1 ‚Äî BACK-UP & PURGE
--------------------------------------------------------------------------------
1. `git tag pre-nuke-$(date +%Y%m%d)`
2. `git ls-files | grep -vE '^(\\.replit|\\.git|\\.gitignore)$' | xargs git rm -rf`
3. `git commit -m "nuke: delete legacy stack"`

================================================================================
PHASE 2 ‚Äî REBUILD BACKEND
--------------------------------------------------------------------------------
A. **Choose stack** by inspecting the `.replit` run line  
   ‚Ä¢ `node`  ‚Üí scaffold **Express** (`server/index.js`)  
   ‚Ä¢ `python`‚Üí scaffold **Flask** (`app.py`) wrapped with `ProxyFix(x_for=1,x_proto=1)`  
   ‚Ä¢ else    ‚Üí default to Node/Express.

B. **Common backend requirements**  
   ‚Ä¢ `app.set('trust proxy', 1);`  // cookies survive Replit proxy  
   ‚Ä¢ Session cookies: `{ httpOnly:true, sameSite:'lax', secure:process.env.NODE_ENV==='production' }`  
   ‚Ä¢ Routes:  
       - `POST /api/login`   ‚Üí create session  
       - `POST /api/logout`  ‚Üí destroy session  
       - `GET  /api/me`      ‚Üí return user JSON (401 if none)  
   ‚Ä¢ Read secrets: `SESSION_SECRET`, any `OAUTH_*`, `JWT_SECRET`.

================================================================================
PHASE 3 ‚Äî REBUILD FRONTEND / UI
--------------------------------------------------------------------------------
1. `public/index.html` ‚Äì login form posting to `/api/login`.
2. `public/app.html`    ‚Äì protected page: on load `fetch("/api/me",{credentials:"include"})`; if 401 ‚Üí `window.location="/"`.
3. `_redirects` file (Netlify style) placed in `public/` or project root:  
       /*    /index.html   200
   (avoids SPA refresh 404s ‚Üí auth loops).
4. Minimal JS/CSS either via **Vite** (matching Node) or plain script tags (matching Flask).

================================================================================
PHASE 4 ‚Äî ONE WORKFLOW
--------------------------------------------------------------------------------
Create `replit.workflows` with ID **build-and-run**:

name = "build-and-run"
[[stages]]
  name = "Install & Test"
  run  = "npm ci && npm run test:smoke"        # or `pip install -r requirements.txt && pytest`
[[stages]]
  name = "Start"
  run  = "npm start"                           # or `python app.py`

================================================================================
PHASE 5 ‚Äî SMOKE TEST SUITE
--------------------------------------------------------------------------------
Add `tests/authLoop.spec.js` (or `.py`):

1. `GET /`                         ‚Üí expect **200**
2. `GET /app.html` unauth          ‚Üí expect **401** or **302 ‚Üí /**  
3. `POST /api/login` (fixture)     ‚Üí expect **200** **+ Set-Cookie**
4. `GET /app.html` with cookie     ‚Üí expect **200**
5. `POST /api/logout`              ‚Üí expect **204**
6. `GET /app.html` after logout    ‚Üí expect **401/302**

Script:
- Node  ‚Üí `npm set-script test:smoke "node tests/authLoop.spec.js"`
- Python‚Üí `pytest -q tests/authLoop.spec.py`

Commit fails if any test fails.

================================================================================
PHASE 6 ‚Äî DEPLOY
--------------------------------------------------------------------------------
1. `git add . && git commit -m "revive: fresh proxy-safe stack"`
2. Trigger **Deployment** in Replit.
3. Echo to console:  
   ‚Ä¢ ‚úîÔ∏è files created  
   ‚Ä¢ ‚úîÔ∏è secrets required  
   ‚Ä¢ ‚úîÔ∏è preview URL  
   ‚Ä¢ üö® smoke-test summary

================================================================================
FAIL-SAFE & ROLLBACK
--------------------------------------------------------------------------------
`git reset --hard pre-nuke-*` instantly restores the old repo if build or tests blow up.

================================================================================
POST-DEPLOY CHECKLIST
--------------------------------------------------------------------------------
‚òê Add all secrets in the Replit sidebar (build will fail without them).  
‚òê Verify only ONE running workflow (avoid port wars).  
‚òê In DevTools, confirm session cookie: **Secure** + **SameSite=Lax**.  
‚òê OAuth redirects point to `https://<your-app>.replit.app`.  
‚òê Keep the `_redirects` catch-all when adding routing later.  
‚òê Re-run smoke tests after every dependency bump.

================================================================================
üöÄ  EXECUTE.  The redirect loop is now a myth told to scare junior devs.  üöÄ