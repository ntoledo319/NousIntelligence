{% extends 'layout.html' %}

{% block title %}{{ shopping_list.name }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-8">
        <a href="{{ url_for('smart_shopping.index') }}" class="btn btn-outline-secondary mb-3">
            <i class="fas fa-arrow-left me-2"></i> Back to Lists
        </a>
        <h1 class="display-5 mb-2">
            <i class="fas fa-shopping-cart text-primary me-2"></i> {{ shopping_list.name }}
        </h1>
        <p class="text-muted">
            {% if shopping_list.store %}
            <i class="fas fa-store me-1"></i> {{ shopping_list.store }} â€¢
            {% endif %}
            <i class="fas fa-calendar me-1"></i> Created {{ shopping_list.created_at.strftime('%Y-%m-%d') }}
        </p>
        {% if shopping_list.description %}
        <p>{{ shopping_list.description }}</p>
        {% endif %}
    </div>
    <div class="col-md-4 text-md-end">
        <a href="{{ url_for('smart_shopping.improve_list', list_id=shopping_list.id) }}" class="btn btn-primary">
            <i class="fas fa-magic me-2"></i> Improve List
        </a>
        <button type="button" class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="fas fa-plus me-2"></i> Add Item
        </button>
    </div>
</div>

<!-- Mobile action buttons -->
<div class="d-block d-md-none mb-4">
    <div class="d-grid gap-2">
        <a href="{{ url_for('smart_shopping.improve_list', list_id=shopping_list.id) }}" class="btn btn-primary">
            <i class="fas fa-magic me-2"></i> Improve List
        </a>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="fas fa-plus me-2"></i> Add Item
        </button>
    </div>
</div>

<!-- List progress -->
{% set checked_count = categorized_items.values()|map('list')|sum(start=[])|selectattr('is_checked', 'eq', True)|list|length %}
{% set total_count = categorized_items.values()|map('list')|sum(start=[])|length %}
{% set progress_percent = (checked_count / total_count * 100) if total_count > 0 else 0 %}

<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Progress</h5>
            <span class="badge bg-primary">{{ checked_count }}/{{ total_count }} items</span>
        </div>
        <div class="progress" style="height: 20px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_percent }}%;" 
                 aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100">
                {{ progress_percent|int }}%
            </div>
        </div>
    </div>
</div>

<!-- Shopping List Items By Category -->
<div class="row mb-4">
    <div class="col-12">
        <!-- Desktop version - list of cards -->
        <div class="d-none d-md-block">
            {% for category, items in categorized_items.items() %}
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{{ category }}</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for item in items %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input item-checkbox" type="checkbox" 
                                       data-item-id="{{ item.id }}" data-list-id="{{ shopping_list.id }}"
                                       id="item-{{ item.id }}" {% if item.is_checked %}checked{% endif %}>
                                <label class="form-check-label {% if item.is_checked %}text-decoration-line-through text-muted{% endif %}" 
                                       for="item-{{ item.id }}">
                                    {{ item.name }}
                                    {% if item.quantity and item.quantity > 1 %}
                                    <span class="badge bg-secondary">{{ item.quantity }} {{ item.unit or '' }}</span>
                                    {% endif %}
                                </label>
                            </div>
                            {% if item.notes %}
                            <small class="text-muted">{{ item.notes }}</small>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Mobile version - accordion -->
        <div class="d-block d-md-none accordion mb-3" id="shoppingAccordion">
            {% for category, items in categorized_items.items() %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ loop.index }}">
                    <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" 
                            aria-expanded="{{ 'true' if loop.first else 'false' }}" 
                            aria-controls="collapse{{ loop.index }}">
                        {{ category }}
                        <span class="badge bg-primary ms-2">{{ items|length }}</span>
                    </button>
                </h2>
                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                     aria-labelledby="heading{{ loop.index }}" data-bs-parent="#shoppingAccordion">
                    <div class="accordion-body p-0">
                        <ul class="list-group list-group-flush">
                            {% for item in items %}
                            <li class="list-group-item">
                                <div class="form-check">
                                    <input class="form-check-input item-checkbox" type="checkbox" 
                                           data-item-id="{{ item.id }}" data-list-id="{{ shopping_list.id }}"
                                           id="mobile-item-{{ item.id }}" {% if item.is_checked %}checked{% endif %}>
                                    <label class="form-check-label {% if item.is_checked %}text-decoration-line-through text-muted{% endif %}" 
                                           for="mobile-item-{{ item.id }}">
                                        {{ item.name }}
                                    </label>
                                </div>
                                {% if item.notes %}
                                <div><small class="text-muted">{{ item.notes }}</small></div>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Suggestions Section -->
{% if suggestions and suggestions.success %}
<div class="card bg-light mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-lightbulb text-warning me-2"></i> Suggestions</h5>
    </div>
    <div class="card-body">
        {% if suggestions.organization_suggestions %}
        <div class="mb-3">
            <h6>Organization Suggestions</h6>
            <p>{{ suggestions.organization_suggestions }}</p>
        </div>
        {% endif %}
        
        {% if suggestions.missing_staples and suggestions.missing_staples|length > 0 %}
        <div>
            <h6>Frequently Purchased Items Missing From This List</h6>
            <div class="row">
                {% for item in suggestions.missing_staples %}
                <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-shopping-basket text-primary me-2"></i>
                        {{ item.name }}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-3">
                <a href="{{ url_for('smart_shopping.improve_list', list_id=shopping_list.id) }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-magic me-2"></i> Add Missing Items
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">Add Item to List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('smart_shopping.add_item', list_id=shopping_list.id) }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Item Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">Select category...</option>
                            {% for category in categorized_items.keys() %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                            <option value="Produce">Produce</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Meat">Meat</option>
                            <option value="Bakery">Bakery</option>
                            <option value="Pantry">Pantry</option>
                            <option value="Frozen">Frozen</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Household">Household</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle item checkboxes
        const checkboxes = document.querySelectorAll('.item-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const itemId = this.getAttribute('data-item-id');
                const listId = this.getAttribute('data-list-id');
                const isChecked = this.checked;
                
                // Update the label styling based on checked state
                const label = document.querySelector(`label[for="${this.id}"]`);
                if (isChecked) {
                    label.classList.add('text-decoration-line-through', 'text-muted');
                } else {
                    label.classList.remove('text-decoration-line-through', 'text-muted');
                }
                
                // Send AJAX request to toggle item status
                fetch(`/smart-shopping/list/${listId}/toggle-item/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        // Revert checkbox if operation failed
                        this.checked = !isChecked;
                        if (!isChecked) {
                            label.classList.add('text-decoration-line-through', 'text-muted');
                        } else {
                            label.classList.remove('text-decoration-line-through', 'text-muted');
                        }
                        alert('Failed to update item status');
                    }
                    
                    // Update the companion checkbox on desktop/mobile
                    const companionSelector = this.id.startsWith('mobile-') 
                        ? `#item-${itemId}` 
                        : `#mobile-item-${itemId}`;
                    const companionCheckbox = document.querySelector(companionSelector);
                    const companionLabel = document.querySelector(`label[for="${companionSelector.substring(1)}"]`);
                    
                    if (companionCheckbox) {
                        companionCheckbox.checked = isChecked;
                        if (companionLabel) {
                            if (isChecked) {
                                companionLabel.classList.add('text-decoration-line-through', 'text-muted');
                            } else {
                                companionLabel.classList.remove('text-decoration-line-through', 'text-muted');
                            }
                        }
                    }
                    
                    // Update progress
                    updateProgress();
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Revert checkbox if operation failed
                    this.checked = !isChecked;
                    alert('Error updating item status');
                });
            });
        });
        
        // Function to update progress
        function updateProgress() {
            const totalItems = document.querySelectorAll('.item-checkbox').length / 2; // Divide by 2 because each item has two checkboxes (mobile and desktop)
            const checkedItems = document.querySelectorAll('.item-checkbox:checked').length / 2;
            const progressPercent = totalItems > 0 ? (checkedItems / totalItems * 100) : 0;
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = `${progressPercent}%`;
            progressBar.setAttribute('aria-valuenow', progressPercent);
            progressBar.textContent = `${Math.round(progressPercent)}%`;
            
            // Update badge
            const badge = document.querySelector('.progress + .badge');
            if (badge) {
                badge.textContent = `${checkedItems}/${totalItems} items`;
            }
        }
    });
</script>

<style>
    /* Mobile optimizations */
    @media (max-width: 767.98px) {
        .form-check-label {
            font-size: 1.1rem;
            padding: 0.25rem 0;
        }
        
        .form-check-input {
            width: 1.2em;
            height: 1.2em;
            margin-top: 0.25em;
        }
    }
</style>
{% endblock %}