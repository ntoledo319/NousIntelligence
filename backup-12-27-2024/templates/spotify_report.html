{% extends "layout.html" %}

{% block title %}Spotify Listening Report{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fab fa-spotify text-success me-2"></i>
                Your Spotify Listening Report
            </h1>
            
            <div class="alert alert-info" id="loading-message">
                <div class="d-flex align-items-center">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>
                        <h5 class="mb-1">Generating your Spotify data visualizations...</h5>
                        <p class="mb-0">This may take a moment while we analyze your listening history.</p>
                    </div>
                </div>
            </div>
            
            <div id="spotify-error" class="alert alert-danger d-none">
                <h5>Oops! Something went wrong</h5>
                <p id="error-message">We couldn't generate your Spotify report.</p>
                <p>
                    <a href="/authorize/spotify" class="btn btn-outline-success">
                        <i class="fab fa-spotify me-2"></i>Connect Spotify
                    </a>
                </p>
            </div>
            
            <div id="report-container" class="d-none">
                <!-- Report tabs -->
                <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                data-bs-target="#overview" type="button" role="tab" 
                                aria-controls="overview" aria-selected="true">
                            Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="top-music-tab" data-bs-toggle="tab" 
                                data-bs-target="#top-music" type="button" role="tab" 
                                aria-controls="top-music" aria-selected="false">
                            Top Music
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="genres-tab" data-bs-toggle="tab" 
                                data-bs-target="#genres" type="button" role="tab" 
                                aria-controls="genres" aria-selected="false">
                            Genres
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" 
                                data-bs-target="#history" type="button" role="tab" 
                                aria-controls="history" aria-selected="false">
                            Listening History
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="features-tab" data-bs-toggle="tab" 
                                data-bs-target="#features" type="button" role="tab" 
                                aria-controls="features" aria-selected="false">
                            Audio Features
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="playlists-tab" data-bs-toggle="tab" 
                                data-bs-target="#playlists" type="button" role="tab" 
                                aria-controls="playlists" aria-selected="false">
                            Analyze Playlists
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content" id="reportTabContent">
                    <!-- Overview tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">Recent Favorites</h5>
                                    </div>
                                    <div class="card-body">
                                        <h6>Top Artists (Last 4 Weeks)</h6>
                                        <div class="image-container mb-4">
                                            <img id="top-artists-short-img" class="img-fluid" alt="Top Artists Chart" />
                                        </div>
                                        
                                        <h6>Top Tracks (Last 4 Weeks)</h6>
                                        <div class="image-container">
                                            <img id="top-tracks-short-img" class="img-fluid" alt="Top Tracks Chart" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">All-Time Favorites</h5>
                                    </div>
                                    <div class="card-body">
                                        <h6>Top Artists (All Time)</h6>
                                        <div class="image-container mb-4">
                                            <img id="top-artists-long-img" class="img-fluid" alt="Top Artists Chart" />
                                        </div>
                                        
                                        <h6>Top Tracks (All Time)</h6>
                                        <div class="image-container">
                                            <img id="top-tracks-long-img" class="img-fluid" alt="Top Tracks Chart" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">Your Music Genres</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="image-container">
                                            <img id="genre-chart-img" class="img-fluid" alt="Genre Chart" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0">Listening Activity</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="image-container">
                                            <img id="listening-history-img" class="img-fluid" alt="Listening History Chart" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Music tab -->
                    <div class="tab-pane fade" id="top-music" role="tabpanel" aria-labelledby="top-music-tab">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Top Artists</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <select id="artists-time-range" class="form-select">
                                                <option value="short_term">Last 4 Weeks</option>
                                                <option value="medium_term" selected>Last 6 Months</option>
                                                <option value="long_term">All Time</option>
                                            </select>
                                        </div>
                                        <div class="image-container">
                                            <img id="top-artists-custom-img" class="img-fluid" alt="Top Artists Chart" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Top Tracks</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <select id="tracks-time-range" class="form-select">
                                                <option value="short_term">Last 4 Weeks</option>
                                                <option value="medium_term" selected>Last 6 Months</option>
                                                <option value="long_term">All Time</option>
                                            </select>
                                        </div>
                                        <div class="image-container">
                                            <img id="top-tracks-custom-img" class="img-fluid" alt="Top Tracks Chart" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Genres tab -->
                    <div class="tab-pane fade" id="genres" role="tabpanel" aria-labelledby="genres-tab">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Your Music Taste by Genre</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <select id="genre-limit" class="form-select">
                                            <option value="5">Top 5 Genres</option>
                                            <option value="10" selected>Top 10 Genres</option>
                                            <option value="15">Top 15 Genres</option>
                                            <option value="20">Top 20 Genres</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="image-container">
                                    <img id="genre-custom-img" class="img-fluid" alt="Genre Chart" />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- History tab -->
                    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Your Listening History</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <select id="history-limit" class="form-select">
                                            <option value="20">Last 20 Tracks</option>
                                            <option value="50" selected>Last 50 Tracks</option>
                                            <option value="100">Last 100 Tracks</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="image-container">
                                    <img id="history-custom-img" class="img-fluid" alt="Listening History Chart" />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Audio Features tab -->
                    <div class="tab-pane fade" id="features" role="tabpanel" aria-labelledby="features-tab">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Track Audio Analysis</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Analyze the audio features of any track on Spotify. You'll see details about 
                                    energy, danceability, acousticness, and more in a visual format.
                                </p>
                                
                                <div class="mb-3">
                                    <label for="track-search" class="form-label">Search for a track</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="track-search" 
                                               placeholder="Enter track name...">
                                        <button class="btn btn-success" type="button" id="search-track-btn">
                                            <i class="fas fa-search me-1"></i> Search
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="track-results" class="mb-3 d-none">
                                    <label class="form-label">Search Results</label>
                                    <div class="list-group" id="track-results-list">
                                        <!-- Track results will be populated here -->
                                    </div>
                                </div>
                                
                                <div id="current-track-container" class="mb-3 d-none">
                                    <div class="alert alert-success">
                                        <strong>Currently analyzing:</strong> 
                                        <span id="current-track-name"></span>
                                    </div>
                                </div>
                                
                                <div class="image-container">
                                    <img id="track-features-img" class="img-fluid d-none" 
                                         alt="Track Audio Features" />
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Compare Tracks</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Compare the audio features of multiple tracks side by side.
                                </p>
                                
                                <div class="mb-3">
                                    <label for="compare-track-search" class="form-label">Add tracks to compare</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="compare-track-search" 
                                               placeholder="Enter track name...">
                                        <button class="btn btn-primary" type="button" id="search-compare-track-btn">
                                            <i class="fas fa-search me-1"></i> Search
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="compare-track-results" class="mb-3 d-none">
                                    <label class="form-label">Search Results</label>
                                    <div class="list-group" id="compare-track-results-list">
                                        <!-- Track results will be populated here -->
                                    </div>
                                </div>
                                
                                <div id="compare-tracks-list" class="mb-3">
                                    <label class="form-label">Tracks to Compare</label>
                                    <ul class="list-group" id="tracks-to-compare">
                                        <li class="list-group-item text-muted">
                                            <em>No tracks added yet. Search and add tracks above.</em>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div class="mb-3">
                                    <button class="btn btn-success" id="generate-comparison-btn" disabled>
                                        <i class="fas fa-chart-bar me-1"></i> Generate Comparison
                                    </button>
                                </div>
                                
                                <div class="image-container">
                                    <img id="track-comparison-img" class="img-fluid d-none" 
                                         alt="Track Comparison" />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Playlists tab -->
                    <div class="tab-pane fade" id="playlists" role="tabpanel" aria-labelledby="playlists-tab">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Analyze Your Playlists</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Select one of your playlists to get a detailed analysis of its musical characteristics, 
                                    including energy levels, mood distribution, and feature breakdowns.
                                </p>
                                
                                <div class="mb-4">
                                    <label for="playlist-select" class="form-label">Select a playlist</label>
                                    <select class="form-select" id="playlist-select">
                                        <option value="">Loading your playlists...</option>
                                    </select>
                                </div>
                                
                                <div id="playlist-analysis-container" class="d-none">
                                    <h4 class="mb-3" id="analyzed-playlist-name"></h4>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-3 mb-3 mb-md-0">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <h3 class="display-4 mb-0" id="playlist-track-count"></h3>
                                                    <p class="card-text">Tracks</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3 mb-md-0">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <h3 class="display-4 mb-0" id="playlist-avg-duration"></h3>
                                                    <p class="card-text">Avg. Duration (min)</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3 mb-md-0">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <h3 class="display-4 mb-0" id="playlist-avg-energy"></h3>
                                                    <p class="card-text">Energy</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <h3 class="display-4 mb-0" id="playlist-avg-dance"></h3>
                                                    <p class="card-text">Danceability</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-4">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0">Mood Analysis</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="image-container">
                                                        <img id="playlist-mood-matrix" class="img-fluid" 
                                                             alt="Playlist Mood Analysis" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-4">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0">Audio Feature Distributions</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="image-container">
                                                        <img id="playlist-feature-dist" class="img-fluid" 
                                                             alt="Playlist Feature Distributions" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let trackSearchResults = [];
    let compareTrackResults = [];
    let tracksToCompare = [];
    let userPlaylists = [];
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadSpotifyReport();
        
        // Event listeners for custom charts
        document.getElementById('artists-time-range').addEventListener('change', loadCustomArtistsChart);
        document.getElementById('tracks-time-range').addEventListener('change', loadCustomTracksChart);
        document.getElementById('genre-limit').addEventListener('change', loadCustomGenreChart);
        document.getElementById('history-limit').addEventListener('change', loadCustomHistoryChart);
        
        // Track search
        document.getElementById('search-track-btn').addEventListener('click', searchTracks);
        document.getElementById('search-compare-track-btn').addEventListener('click', searchTracksForComparison);
        document.getElementById('generate-comparison-btn').addEventListener('click', generateTrackComparison);
        
        // Playlist analysis
        document.getElementById('playlist-select').addEventListener('change', analyzePlaylist);
        
        // Load playlists when the playlists tab is shown
        const playlistsTab = document.getElementById('playlists-tab');
        playlistsTab.addEventListener('shown.bs.tab', function (e) {
            loadUserPlaylists();
        });
    });
    
    // Load the full Spotify report
    function loadSpotifyReport() {
        fetch('/api/spotify/visualization/report')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load Spotify report');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.report) {
                    displayReport(data.report);
                } else {
                    showError(data.error || 'Failed to generate report');
                }
            })
            .catch(error => {
                showError(error.message);
            })
            .finally(() => {
                document.getElementById('loading-message').classList.add('d-none');
            });
    }
    
    // Display the report data
    function displayReport(report) {
        // Show the report container
        document.getElementById('report-container').classList.remove('d-none');
        
        // Set the images
        if (report.top_artists_short) {
            document.getElementById('top-artists-short-img').src = 'data:image/png;base64,' + report.top_artists_short;
        }
        
        if (report.top_artists_long) {
            document.getElementById('top-artists-long-img').src = 'data:image/png;base64,' + report.top_artists_long;
        }
        
        if (report.top_tracks_short) {
            document.getElementById('top-tracks-short-img').src = 'data:image/png;base64,' + report.top_tracks_short;
        }
        
        if (report.top_tracks_long) {
            document.getElementById('top-tracks-long-img').src = 'data:image/png;base64,' + report.top_tracks_long;
        }
        
        if (report.genre_chart) {
            document.getElementById('genre-chart-img').src = 'data:image/png;base64,' + report.genre_chart;
        }
        
        if (report.listening_history) {
            document.getElementById('listening-history-img').src = 'data:image/png;base64,' + report.listening_history;
        }
        
        // Also set the custom tab images initially
        if (report.top_artists_long) {
            document.getElementById('top-artists-custom-img').src = 'data:image/png;base64,' + report.top_artists_long;
        }
        
        if (report.top_tracks_long) {
            document.getElementById('top-tracks-custom-img').src = 'data:image/png;base64,' + report.top_tracks_long;
        }
        
        if (report.genre_chart) {
            document.getElementById('genre-custom-img').src = 'data:image/png;base64,' + report.genre_chart;
        }
        
        if (report.listening_history) {
            document.getElementById('history-custom-img').src = 'data:image/png;base64,' + report.listening_history;
        }
        
        // Set track features if available
        if (report.current_track_features && report.current_track_info) {
            document.getElementById('track-features-img').src = 'data:image/png;base64,' + report.current_track_features;
            document.getElementById('track-features-img').classList.remove('d-none');
            
            document.getElementById('current-track-container').classList.remove('d-none');
            document.getElementById('current-track-name').textContent = 
                `${report.current_track_info.name} by ${report.current_track_info.artist}`;
        }
    }
    
    // Load a custom artists chart
    function loadCustomArtistsChart() {
        const timeRange = document.getElementById('artists-time-range').value;
        
        fetch(`/api/spotify/visualization/artists?time_range=${timeRange}&limit=10`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load artists chart');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.image) {
                    document.getElementById('top-artists-custom-img').src = 'data:image/png;base64,' + data.image;
                }
            })
            .catch(error => {
                console.error('Error loading artists chart:', error);
            });
    }
    
    // Load a custom tracks chart
    function loadCustomTracksChart() {
        const timeRange = document.getElementById('tracks-time-range').value;
        
        fetch(`/api/spotify/visualization/tracks?time_range=${timeRange}&limit=10`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load tracks chart');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.image) {
                    document.getElementById('top-tracks-custom-img').src = 'data:image/png;base64,' + data.image;
                }
            })
            .catch(error => {
                console.error('Error loading tracks chart:', error);
            });
    }
    
    // Load a custom genre chart
    function loadCustomGenreChart() {
        const limit = document.getElementById('genre-limit').value;
        
        fetch(`/api/spotify/visualization/genres?limit=${limit}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load genre chart');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.image) {
                    document.getElementById('genre-custom-img').src = 'data:image/png;base64,' + data.image;
                }
            })
            .catch(error => {
                console.error('Error loading genre chart:', error);
            });
    }
    
    // Load a custom listening history chart
    function loadCustomHistoryChart() {
        const limit = document.getElementById('history-limit').value;
        
        fetch(`/api/spotify/visualization/history?limit=${limit}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load history chart');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.image) {
                    document.getElementById('history-custom-img').src = 'data:image/png;base64,' + data.image;
                }
            })
            .catch(error => {
                console.error('Error loading history chart:', error);
            });
    }
    
    // Search for tracks
    function searchTracks() {
        const query = document.getElementById('track-search').value.trim();
        if (!query) return;
        
        // This function would call a backend endpoint to search Spotify
        // For simplicity, we'll simulate it with a placeholder
        // In a real implementation, you would add a new endpoint to search tracks
        
        // Show results container
        document.getElementById('track-results').classList.remove('d-none');
        document.getElementById('track-results-list').innerHTML = 
            '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
        
        // Simulate an API call
        setTimeout(() => {
            // This is where you would make a real API call to search tracks
            // For demo purposes, we'll use a mock response
            trackSearchResults = [
                { id: 'track1', name: 'Sample Track 1', artist: 'Artist 1' },
                { id: 'track2', name: 'Sample Track 2', artist: 'Artist 2' },
                { id: 'track3', name: 'Sample Track 3', artist: 'Artist 3' }
            ];
            
            displayTrackResults();
        }, 1000);
    }
    
    // Display track search results
    function displayTrackResults() {
        const resultsContainer = document.getElementById('track-results-list');
        resultsContainer.innerHTML = '';
        
        if (trackSearchResults.length === 0) {
            resultsContainer.innerHTML = '<div class="text-center">No tracks found</div>';
            return;
        }
        
        trackSearchResults.forEach(track => {
            const item = document.createElement('button');
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `<strong>${track.name}</strong> by ${track.artist}`;
            item.onclick = () => analyzeTrack(track.id, track.name, track.artist);
            resultsContainer.appendChild(item);
        });
    }
    
    // Analyze a track's audio features
    function analyzeTrack(trackId, trackName, artistName) {
        // Update current track info
        document.getElementById('current-track-container').classList.remove('d-none');
        document.getElementById('current-track-name').textContent = `${trackName} by ${artistName}`;
        
        // Hide track results
        document.getElementById('track-results').classList.add('d-none');
        
        // Show loading state
        document.getElementById('track-features-img').classList.add('d-none');
        
        // Get track features
        fetch(`/api/spotify/visualization/track-features?track_id=${trackId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load track features');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.image) {
                    document.getElementById('track-features-img').src = 'data:image/png;base64,' + data.image;
                    document.getElementById('track-features-img').classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error loading track features:', error);
            });
    }
    
    // Search tracks for comparison
    function searchTracksForComparison() {
        const query = document.getElementById('compare-track-search').value.trim();
        if (!query) return;
        
        // Show results container
        document.getElementById('compare-track-results').classList.remove('d-none');
        document.getElementById('compare-track-results-list').innerHTML = 
            '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
        
        // Simulate an API call
        setTimeout(() => {
            // This is where you would make a real API call to search tracks
            // For demo purposes, we'll use a mock response
            compareTrackResults = [
                { id: 'track1', name: 'Sample Track 1', artist: 'Artist 1' },
                { id: 'track2', name: 'Sample Track 2', artist: 'Artist 2' },
                { id: 'track3', name: 'Sample Track 3', artist: 'Artist 3' }
            ];
            
            displayCompareTrackResults();
        }, 1000);
    }
    
    // Display track search results for comparison
    function displayCompareTrackResults() {
        const resultsContainer = document.getElementById('compare-track-results-list');
        resultsContainer.innerHTML = '';
        
        if (compareTrackResults.length === 0) {
            resultsContainer.innerHTML = '<div class="text-center">No tracks found</div>';
            return;
        }
        
        compareTrackResults.forEach(track => {
            const item = document.createElement('button');
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `<strong>${track.name}</strong> by ${track.artist}`;
            item.onclick = () => addTrackToComparison(track);
            resultsContainer.appendChild(item);
        });
    }
    
    // Add a track to the comparison list
    function addTrackToComparison(track) {
        // Check if track is already in the list
        if (tracksToCompare.some(t => t.id === track.id)) {
            return;
        }
        
        // Add to the list
        tracksToCompare.push(track);
        
        // Update the UI
        updateTracksToCompareList();
        
        // Hide results
        document.getElementById('compare-track-results').classList.add('d-none');
        
        // Enable the compare button if we have at least 2 tracks
        if (tracksToCompare.length >= 2) {
            document.getElementById('generate-comparison-btn').disabled = false;
        }
    }
    
    // Update the list of tracks to compare
    function updateTracksToCompareList() {
        const container = document.getElementById('tracks-to-compare');
        container.innerHTML = '';
        
        if (tracksToCompare.length === 0) {
            container.innerHTML = `
                <li class="list-group-item text-muted">
                    <em>No tracks added yet. Search and add tracks above.</em>
                </li>
            `;
            return;
        }
        
        tracksToCompare.forEach((track, index) => {
            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <div>
                    <strong>${track.name}</strong> by ${track.artist}
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeTrackFromComparison(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(item);
        });
    }
    
    // Remove a track from the comparison list
    function removeTrackFromComparison(index) {
        tracksToCompare.splice(index, 1);
        updateTracksToCompareList();
        
        // Disable the compare button if we have fewer than 2 tracks
        if (tracksToCompare.length < 2) {
            document.getElementById('generate-comparison-btn').disabled = true;
        }
    }
    
    // Generate a comparison of tracks
    function generateTrackComparison() {
        if (tracksToCompare.length < 2) {
            return;
        }
        
        // Hide any existing comparison
        document.getElementById('track-comparison-img').classList.add('d-none');
        
        // Prepare the request data
        const data = {
            track_ids: tracksToCompare.map(track => track.id),
            track_names: tracksToCompare.map(track => `${track.name} - ${track.artist}`)
        };
        
        // Make the API request
        fetch('/api/spotify/visualization/compare-tracks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to generate comparison');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.image) {
                document.getElementById('track-comparison-img').src = 'data:image/png;base64,' + data.image;
                document.getElementById('track-comparison-img').classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error generating comparison:', error);
        });
    }
    
    // Load user's playlists
    function loadUserPlaylists() {
        // Check if we've already loaded playlists
        if (userPlaylists.length > 0) {
            return;
        }
        
        const playlistSelect = document.getElementById('playlist-select');
        playlistSelect.innerHTML = '<option value="">Loading your playlists...</option>';
        
        // In a real implementation, you would add a new endpoint to get user playlists
        // For simplicity, we'll simulate it
        
        // Simulate an API call
        setTimeout(() => {
            // This is where you would make a real API call to get playlists
            // For demo purposes, we'll use a mock response
            userPlaylists = [
                { id: 'playlist1', name: 'Sample Playlist 1' },
                { id: 'playlist2', name: 'Sample Playlist 2' },
                { id: 'playlist3', name: 'Sample Playlist 3' }
            ];
            
            // Update the select element
            playlistSelect.innerHTML = '<option value="">Select a playlist...</option>';
            userPlaylists.forEach(playlist => {
                const option = document.createElement('option');
                option.value = playlist.id;
                option.textContent = playlist.name;
                playlistSelect.appendChild(option);
            });
        }, 1000);
    }
    
    // Analyze a playlist
    function analyzePlaylist() {
        const playlistId = document.getElementById('playlist-select').value;
        if (!playlistId) {
            document.getElementById('playlist-analysis-container').classList.add('d-none');
            return;
        }
        
        // Show loading state
        document.getElementById('playlist-analysis-container').classList.add('d-none');
        
        // Get playlist analysis
        fetch(`/api/spotify/visualization/playlist-analysis?playlist_id=${playlistId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to analyze playlist');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.analysis) {
                    displayPlaylistAnalysis(data.analysis);
                }
            })
            .catch(error => {
                console.error('Error analyzing playlist:', error);
            });
    }
    
    // Display playlist analysis results
    function displayPlaylistAnalysis(analysis) {
        // Show the analysis container
        document.getElementById('playlist-analysis-container').classList.remove('d-none');
        
        // Set playlist name
        document.getElementById('analyzed-playlist-name').textContent = 
            `${analysis.playlist_name} by ${analysis.playlist_owner}`;
        
        // Set stats
        document.getElementById('playlist-track-count').textContent = 
            analysis.stats.track_count;
            
        document.getElementById('playlist-avg-duration').textContent = 
            analysis.stats.avg_duration_min.toFixed(1);
            
        document.getElementById('playlist-avg-energy').textContent = 
            (analysis.stats.avg_energy * 100).toFixed(0) + '%';
            
        document.getElementById('playlist-avg-dance').textContent = 
            (analysis.stats.avg_danceability * 100).toFixed(0) + '%';
        
        // Set images
        if (analysis.charts.mood_matrix) {
            document.getElementById('playlist-mood-matrix').src = 
                'data:image/png;base64,' + analysis.charts.mood_matrix;
        }
        
        if (analysis.charts.feature_distributions) {
            document.getElementById('playlist-feature-dist').src = 
                'data:image/png;base64,' + analysis.charts.feature_distributions;
        }
    }
    
    // Show error message
    function showError(message) {
        const errorContainer = document.getElementById('spotify-error');
        const errorMessage = document.getElementById('error-message');
        
        errorMessage.textContent = message;
        errorContainer.classList.remove('d-none');
    }
</script>
{% endblock %}

{% block styles %}
<style>
    .image-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .image-container img {
        max-width: 100%;
        max-height: 600px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 4px;
    }
    
    .card {
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,0.125);
        padding: 12px 20px;
    }
    
    .tab-content {
        padding-top: 20px;
    }
    
    .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
    }
    
    .nav-tabs .nav-link.active {
        font-weight: 600;
    }
</style>
{% endblock %}