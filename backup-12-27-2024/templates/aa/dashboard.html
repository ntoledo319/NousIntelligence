{% extends 'aa/layout.html' %}

{% block aa_content %}
<div class="row">
    <div class="col-12 mb-4">
        <h1>Recovery Dashboard</h1>
        <p class="text-muted">Your daily recovery companion</p>
    </div>
</div>

<div class="row">
    <!-- Stats overview -->
    <div class="col-md-4 mb-4">
        <div class="aa-card dashboard-widget">
            <div class="aa-card-title">Recovery Stats</div>
            
            {% if stats %}
                <div class="d-flex flex-column align-items-center mb-3">
                    <div class="mb-1">Days Sober</div>
                    <div class="aa-stats">{{ stats.days_sober or 0 }}</div>
                    {% if stats.sober_since %}
                        <div class="text-muted">Since {{ stats.sober_since }}</div>
                    {% endif %}
                </div>
                
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="mb-1">Meetings</div>
                        <div class="h4">{{ stats.meetings_attended or 0 }}</div>
                    </div>
                    <div class="col-4">
                        <div class="mb-1">Honesty</div>
                        <div class="h4">{{ stats.total_honest_admits or 0 }}</div>
                    </div>
                    <div class="col-4">
                        <div class="mb-1">Streak</div>
                        <div class="h4">{{ stats.current_streak or 0 }}</div>
                    </div>
                </div>
                
                {% if stats.badges %}
                    <div class="mb-2">Recent badges:</div>
                    {% for badge in stats.badges[:3] %}
                        <span class="aa-badge aa-badge-primary">{{ badge.badge_name }}</span>
                    {% endfor %}
                {% endif %}
            {% else %}
                <p>No recovery stats available yet. Start your journey!</p>
            {% endif %}
            
            <div class="mt-3">
                <a href="{{ url_for('aa_routes.stats') }}" class="btn btn-outline-primary btn-sm">View all stats</a>
            </div>
        </div>
    </div>
    
    <!-- Daily Reflection -->
    <div class="col-md-8 mb-4">
        <div class="aa-card dashboard-widget">
            <div class="aa-card-title">Daily Reflection</div>
            
            {% if reflection %}
                <div class="reflection-card">
                    {% if reflection.content %}
                        <div class="reflection-content">{{ reflection.content }}</div>
                        {% if reflection.source %}
                            <div class="reflection-source">â€” {{ reflection.source }}</div>
                        {% endif %}
                    {% elif reflection.prompt %}
                        <div class="reflection-content">{{ reflection.prompt }}</div>
                    {% endif %}
                </div>
                
                <form action="{{ url_for('aa_routes.reflection_response') }}" method="post">
                    <input type="hidden" name="reflection_content" value="{{ reflection.content or reflection.prompt }}">
                    
                    <div class="form-group mb-3">
                        <label for="response">Your response:</label>
                        <textarea class="form-control" id="response" name="response_content" rows="3" placeholder="Write your thoughts on this reflection..." required></textarea>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is_honest_admit" name="is_honest_admit">
                        <label class="form-check-label" for="is_honest_admit">
                            This response includes an honest admission (counts toward honesty streak)
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Response</button>
                </form>
            {% else %}
                <p>No reflection available. Please try again later.</p>
            {% endif %}
            
            <div class="mt-3">
                <a href="{{ url_for('aa_routes.reflections', reflection_type='morning') }}" class="btn btn-outline-primary btn-sm me-2">Morning Reflection</a>
                <a href="{{ url_for('aa_routes.reflections', reflection_type='evening') }}" class="btn btn-outline-primary btn-sm">Evening Reflection</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Nightly Inventory -->
    {% if inventory %}
    <div class="col-md-6 mb-4">
        <div class="aa-card dashboard-widget">
            <div class="aa-card-title">Nightly Inventory</div>
            
            <p>Take a few minutes to complete your nightly inventory:</p>
            
            <a href="{{ url_for('aa_routes.nightly_inventory') }}" class="btn btn-primary">Start Nightly Inventory</a>
        </div>
    </div>
    {% endif %}
    
    <!-- Spot Checks -->
    <div class="col-md-6 mb-4">
        <div class="aa-card dashboard-widget">
            <div class="aa-card-title">Spot-Check Inventory</div>
            
            <p>Take a quick moment for self-assessment:</p>
            
            <a href="{{ url_for('aa_routes.spot_check') }}" class="btn btn-primary mb-3">Random Spot-Check</a>
            
            <div class="dropdown d-inline-block mb-3 ms-2">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="spotCheckDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Choose Category
                </button>
                <ul class="dropdown-menu" aria-labelledby="spotCheckDropdown">
                    <li><a class="dropdown-item" href="{{ url_for('aa_routes.spot_check', category='resentment') }}">Resentment</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('aa_routes.spot_check', category='selfish') }}">Selfishness</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('aa_routes.spot_check', category='dishonesty') }}">Dishonesty</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('aa_routes.spot_check', category='fear') }}">Fear</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('aa_routes.spot_check', category='anger') }}">Anger</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('aa_routes.spot_check', category='service') }}">Service</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('aa_routes.spot_check', category='gratitude') }}">Gratitude</a></li>
                </ul>
            </div>
            
            {% if recent_spot_checks %}
                <div class="mt-3">
                    <h6>Recent Spot-Checks:</h6>
                    <div class="list-group">
                        {% for check in recent_spot_checks %}
                            <div class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ check.question }}</h6>
                                    <small>{{ check.timestamp.strftime('%m/%d %H:%M') }}</small>
                                </div>
                                <p class="mb-1">{{ check.response }}</p>
                                <small class="text-muted">Type: {{ check.check_type }}</small>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <!-- Sponsor Quick-Call -->
    <div class="col-md-6 mb-4">
        <div class="aa-card dashboard-widget">
            <div class="aa-card-title">Sponsor Quick-Call</div>
            
            {% if settings and settings.sponsor_phone %}
                <div class="sponsor-card mb-3">
                    <div class="mb-2"><strong>{{ settings.sponsor_name }}</strong></div>
                    <div class="sponsor-number">{{ settings.sponsor_phone }}</div>
                    <div class="mt-2">
                        <a href="tel:{{ settings.sponsor_phone }}" class="btn btn-success btn-sm">
                            <i class="fas fa-phone"></i> Call Now
                        </a>
                        <a href="{{ url_for('aa_routes.sponsor') }}" class="btn btn-outline-secondary btn-sm">
                            Log Call
                        </a>
                    </div>
                </div>
                
                {% if settings.backup_contact_phone %}
                    <div class="sponsor-card">
                        <div class="mb-2"><strong>{{ settings.backup_contact_name }}</strong> (Backup)</div>
                        <div class="sponsor-number">{{ settings.backup_contact_phone }}</div>
                        <div class="mt-2">
                            <a href="tel:{{ settings.backup_contact_phone }}" class="btn btn-success btn-sm">
                                <i class="fas fa-phone"></i> Call Now
                            </a>
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <p>No sponsor information set up yet.</p>
                <a href="{{ url_for('aa_routes.settings') }}" class="btn btn-primary btn-sm">
                    Add Sponsor Information
                </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Find Meetings -->
    <div class="col-md-6 mb-4">
        <div class="aa-card dashboard-widget">
            <div class="aa-card-title">Find Meetings</div>
            
            <form action="{{ url_for('aa_routes.meetings') }}" method="post" class="mb-3">
                <div class="row">
                    <div class="col-8">
                        <input type="text" class="form-control" name="zip_code" placeholder="Enter ZIP code" required>
                    </div>
                    <div class="col-4">
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </div>
                </div>
            </form>
            
            <div>
                <a href="{{ url_for('aa_routes.meetings') }}" class="btn btn-outline-secondary btn-sm">
                    Advanced Search
                </a>
            </div>
        </div>
    </div>
</div>

{% if pain_flare_enabled %}
<div class="row">
    <!-- Pain Flare Monitor -->
    <div class="col-md-12 mb-4">
        <div class="aa-card dashboard-widget">
            <div class="aa-card-title">Pain Flare Monitor</div>
            
            <p>Check today's pain flare risk based on weather conditions.</p>
            
            <a href="{{ url_for('aa_routes.pain_flares') }}" class="btn btn-primary btn-sm">
                View Pain Flare Risk
            </a>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Crisis Resources -->
    <div class="col-md-12">
        <div class="aa-card dashboard-widget" style="background-color: #fff3cd; border-left: 5px solid #ffc107;">
            <div class="aa-card-title">Need Help Now?</div>
            
            <p>If you're in crisis or struggling with urges, help is available right now.</p>
            
            <div class="d-flex flex-wrap">
                <a href="{{ url_for('aa_routes.crisis') }}" class="btn btn-warning me-2 mb-2">
                    <i class="fas fa-exclamation-triangle"></i> Crisis Resources
                </a>
                
                <a href="{{ url_for('aa_routes.mindfulness') }}" class="btn btn-outline-secondary me-2 mb-2">
                    <i class="fas fa-brain"></i> Coping Techniques
                </a>
                
                <a href="{{ url_for('aa_routes.forum') }}" class="btn btn-outline-secondary mb-2">
                    <i class="fas fa-comments"></i> Peer Support
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}