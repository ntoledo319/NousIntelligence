{% extends "layout.html" %}

{% block title %}Voice Emotion Analysis{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Voice Emotion Analysis</h4>
                </div>
                <div class="card-body">
                    <p class="lead">Record your voice to analyze your emotional tone.</p>
                    
                    <div class="mb-4">
                        <button id="recordButton" class="btn btn-danger">
                            <i class="fas fa-microphone"></i> Start Recording
                        </button>
                        <button id="stopButton" class="btn btn-secondary" disabled>
                            <i class="fas fa-stop"></i> Stop Recording
                        </button>
                        <span id="recordingStatus" class="ms-3 text-muted"></span>
                    </div>
                    
                    <div id="audioPreview" class="d-none mb-4">
                        <h5>Your Recording:</h5>
                        <audio id="audioPlayback" controls class="w-100"></audio>
                        <button id="analyzeButton" class="btn btn-primary mt-2">
                            <i class="fas fa-brain"></i> Analyze Emotion
                        </button>
                    </div>
                    
                    <div id="loadingIndicator" class="d-none">
                        <div class="text-center my-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Analyzing your voice...</p>
                        </div>
                    </div>
                    
                    <div id="analysisResults" class="d-none">
                        <h5>Analysis Results</h5>
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6 class="emotion-name mb-3"></h6>
                                <div class="feedback mb-3"></div>
                                
                                <div class="mb-3">
                                    <h6>Detected Emotions:</h6>
                                    <div class="emotions-bar-container">
                                        <!-- Emotions bars will be added dynamically -->
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Voice Characteristics:</h6>
                                        <table class="table table-sm">
                                            <tbody id="voiceFeatures">
                                                <!-- Voice features will be added dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-center mb-2">
                                            <div id="emotionIcon" class="display-1">üòê</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="errorMessage" class="alert alert-danger d-none mt-3"></div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        This feature uses privacy-preserving Hugging Face models for emotion analysis without storing your voice data.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const recordingStatus = document.getElementById('recordingStatus');
        const audioPreview = document.getElementById('audioPreview');
        const audioPlayback = document.getElementById('audioPlayback');
        const analyzeButton = document.getElementById('analyzeButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const analysisResults = document.getElementById('analysisResults');
        const errorMessage = document.getElementById('errorMessage');
        
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        
        // Check for microphone access
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                recordButton.disabled = false;
                
                // Set up the media recorder
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });
                
                mediaRecorder.addEventListener('stop', () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.src = audioUrl;
                    audioPreview.classList.remove('d-none');
                    recordingStatus.textContent = 'Recording complete';
                });
            })
            .catch(error => {
                recordButton.disabled = true;
                showError('Microphone access denied. Please enable microphone access in your browser settings.');
                console.error('Error accessing microphone:', error);
            });
        
        // Start recording
        recordButton.addEventListener('click', () => {
            audioChunks = [];
            mediaRecorder.start();
            recordButton.disabled = true;
            stopButton.disabled = false;
            recordingStatus.textContent = 'Recording...';
            analysisResults.classList.add('d-none');
            errorMessage.classList.add('d-none');
        });
        
        // Stop recording
        stopButton.addEventListener('click', () => {
            mediaRecorder.stop();
            recordButton.disabled = false;
            stopButton.disabled = true;
        });
        
        // Analyze the recording
        analyzeButton.addEventListener('click', () => {
            if (!audioBlob) {
                showError('No recording available. Please record your voice first.');
                return;
            }
            
            // Show loading indicator
            loadingIndicator.classList.remove('d-none');
            analysisResults.classList.add('d-none');
            errorMessage.classList.add('d-none');
            
            // Send the audio for analysis
            const formData = new FormData();
            formData.append('audio', audioBlob);
            
            fetch('/voice/analyze_emotion', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Analysis failed. Please try again.');
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                loadingIndicator.classList.add('d-none');
                
                if (data.success) {
                    displayResults(data.result);
                } else {
                    showError(data.error || 'Analysis failed. Please try again.');
                }
            })
            .catch(error => {
                loadingIndicator.classList.add('d-none');
                showError(error.message || 'Analysis failed. Please try again.');
                console.error('Error analyzing audio:', error);
            });
        });
        
        function displayResults(result) {
            // Show results container
            analysisResults.classList.remove('d-none');
            
            // Display the primary emotion
            const emotionName = document.querySelector('.emotion-name');
            emotionName.textContent = `Primary emotion: ${result.emotion.toUpperCase()} (${Math.round(result.confidence * 100)}% confidence)`;
            
            // Display the feedback
            const feedback = document.querySelector('.feedback');
            feedback.textContent = result.feedback || '';
            
            // Display all emotions as bars
            const emotionsContainer = document.querySelector('.emotions-bar-container');
            emotionsContainer.innerHTML = '';
            
            if (result.all_emotions) {
                const emotions = Object.entries(result.all_emotions).sort((a, b) => b[1] - a[1]);
                
                emotions.forEach(([emotion, score]) => {
                    const percentage = Math.round(score * 100);
                    const barHTML = `
                        <div class="emotion-bar-row mb-1">
                            <div class="d-flex justify-content-between mb-1">
                                <span>${emotion}</span>
                                <span>${percentage}%</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-${getColorForEmotion(emotion)}" 
                                     role="progressbar" 
                                     style="width: ${percentage}%" 
                                     aria-valuenow="${percentage}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100"></div>
                            </div>
                        </div>
                    `;
                    emotionsContainer.innerHTML += barHTML;
                });
            }
            
            // Display voice features
            const featuresTable = document.getElementById('voiceFeatures');
            featuresTable.innerHTML = '';
            
            if (result.audio_features) {
                Object.entries(result.audio_features).forEach(([feature, value]) => {
                    const percentage = Math.round(value * 100);
                    const formattedFeature = feature.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formattedFeature}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar bg-info" 
                                     role="progressbar" 
                                     style="width: ${percentage}%" 
                                     aria-valuenow="${percentage}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">${percentage}%</div>
                            </div>
                        </td>
                    `;
                    featuresTable.appendChild(row);
                });
            }
            
            // Set the emotion icon
            const emotionIcon = document.getElementById('emotionIcon');
            emotionIcon.textContent = getEmotionEmoji(result.emotion);
        }
        
        function getColorForEmotion(emotion) {
            const colors = {
                'angry': 'danger',
                'disgust': 'warning',
                'fear': 'dark',
                'happy': 'success',
                'neutral': 'secondary',
                'sad': 'primary',
                'surprise': 'info'
            };
            
            return colors[emotion.toLowerCase()] || 'secondary';
        }
        
        function getEmotionEmoji(emotion) {
            const emojis = {
                'angry': 'üò†',
                'disgust': 'ü§¢',
                'fear': 'üò®',
                'happy': 'üòÑ',
                'neutral': 'üòê',
                'sad': 'üò¢',
                'surprise': 'üò≤'
            };
            
            return emojis[emotion.toLowerCase()] || 'üòê';
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('d-none');
        }
    });
</script>
{% endblock %}