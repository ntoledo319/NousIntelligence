{% extends "base.html" %}

{% block title %}{{ profile.language_name }} Vocabulary | NOUS{% endblock %}

{% block styles %}
<style>
    .vocabulary-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .vocabulary-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .mastery-0 { border-left: 5px solid #dc3545; }
    .mastery-1 { border-left: 5px solid #fd7e14; }
    .mastery-2 { border-left: 5px solid #ffc107; }
    .mastery-3 { border-left: 5px solid #20c997; }
    .mastery-4 { border-left: 5px solid #198754; }
    
    .card-flip {
        perspective: 1000px;
        height: 200px;
    }
    .card-flip-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }
    .card-flip.flipped .card-flip-inner {
        transform: rotateY(180deg);
    }
    .card-front, .card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .card-back {
        transform: rotateY(180deg);
    }
    .filters {
        transition: max-height 0.3s ease-out;
        max-height: 0;
        overflow: hidden;
    }
    .filters.show {
        max-height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('language.index') }}">Language Learning</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('language.profile', profile_id=profile.profile.id) }}">{{ profile.language_name }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Vocabulary</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1>{{ profile.language_name }} Vocabulary</h1>
                <div>
                    <a href="{{ url_for('language.practice_vocabulary', profile_id=profile.profile.id) }}" class="btn btn-success me-2">
                        <i class="fas fa-play"></i> Practice
                    </a>
                    <a href="{{ url_for('language.add_vocabulary', profile_id=profile.profile.id) }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Words
                    </a>
                </div>
            </div>
            
            {% include "partials/flash_messages.html" %}
        </div>
    </div>
    
    <!-- Vocabulary Statistics -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <h5>Total Words</h5>
                            <h2>{{ profile.vocabulary_count }}</h2>
                        </div>
                        <div class="col-md-9">
                            <h5>Mastery Progress</h5>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: {{ profile.vocabulary_by_mastery.beginner / profile.vocabulary_count * 100 if profile.vocabulary_count else 0 }}%" 
                                    title="New: {{ profile.vocabulary_by_mastery.beginner }}">
                                    {{ profile.vocabulary_by_mastery.beginner }}
                                </div>
                                <div class="progress-bar bg-warning" role="progressbar" style="width: {{ profile.vocabulary_by_mastery.learning / profile.vocabulary_count * 100 if profile.vocabulary_count else 0 }}%" 
                                    title="Learning: {{ profile.vocabulary_by_mastery.learning }}">
                                    {{ profile.vocabulary_by_mastery.learning }}
                                </div>
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ profile.vocabulary_by_mastery.mastered / profile.vocabulary_count * 100 if profile.vocabulary_count else 0 }}%" 
                                    title="Mastered: {{ profile.vocabulary_by_mastery.mastered }}">
                                    {{ profile.vocabulary_by_mastery.mastered }}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span><i class="fas fa-circle text-danger"></i> New</span>
                                <span><i class="fas fa-circle text-warning"></i> Learning</span>
                                <span><i class="fas fa-circle text-success"></i> Mastered</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Vocabulary List -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Vocabulary List</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="toggleFilters">
                                <i class="fas fa-filter"></i> Filters
                            </button>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary active">All</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary">New</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary">Learning</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary">Mastered</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body filters" id="filterPanel">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="masteryFilter" class="form-label">Mastery Level</label>
                                <select class="form-select" id="masteryFilter">
                                    <option value="all" selected>All Levels</option>
                                    <option value="beginner">New (0-30%)</option>
                                    <option value="learning">Learning (30-70%)</option>
                                    <option value="mastered">Mastered (70-100%)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="partOfSpeechFilter" class="form-label">Part of Speech</label>
                                <select class="form-select" id="partOfSpeechFilter">
                                    <option value="all" selected>All</option>
                                    <option value="noun">Nouns</option>
                                    <option value="verb">Verbs</option>
                                    <option value="adjective">Adjectives</option>
                                    <option value="adverb">Adverbs</option>
                                    <option value="preposition">Prepositions</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="sortBy" class="form-label">Sort By</label>
                                <select class="form-select" id="sortBy">
                                    <option value="mastery">Mastery (Lowest First)</option>
                                    <option value="mastery_desc">Mastery (Highest First)</option>
                                    <option value="alphabetical">Alphabetical (A-Z)</option>
                                    <option value="alphabetical_desc">Alphabetical (Z-A)</option>
                                    <option value="reviewed">Last Reviewed</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="searchVocab" class="form-label">Search</label>
                                <input type="text" class="form-control" id="searchVocab" placeholder="Search words...">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="vocabularyTable">
                        <thead>
                            <tr>
                                <th>Word</th>
                                <th>Translation</th>
                                <th>Part of Speech</th>
                                <th>Pronunciation</th>
                                <th>Mastery</th>
                                <th>Last Reviewed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if vocabulary_items %}
                                {% for item in vocabulary_items %}
                                    <tr class="vocabulary-item" data-mastery="{{ item.mastery_level }}" data-speech="{{ item.part_of_speech }}">
                                        <td>{{ item.word }}</td>
                                        <td>{{ item.translation }}</td>
                                        <td>{{ item.part_of_speech|title if item.part_of_speech else '-' }}</td>
                                        <td>
                                            {% if item.pronunciation %}
                                                <span class="me-2">{{ item.pronunciation }}</span>
                                                <button class="btn btn-sm btn-outline-secondary btn-play-pronunciation" data-word="{{ item.word }}" data-language="{{ profile.profile.learning_language }}">
                                                    <i class="fas fa-volume-up"></i>
                                                </button>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar {% if item.mastery_level < 0.3 %}bg-danger{% elif item.mastery_level < 0.7 %}bg-warning{% else %}bg-success{% endif %}" 
                                                     role="progressbar" 
                                                     style="width: {{ item.mastery_level * 100 }}%"></div>
                                            </div>
                                            <small>{{ (item.mastery_level * 100)|int }}%</small>
                                        </td>
                                        <td>{{ item.last_reviewed.strftime('%b %d, %Y') if item.last_reviewed else 'Never' }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary btn-edit" data-id="{{ item.id }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger btn-delete" data-id="{{ item.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                                        <h5>No vocabulary items yet</h5>
                                        <p class="text-muted">Start building your vocabulary by adding new words!</p>
                                        <a href="{{ url_for('language.add_vocabulary', profile_id=profile.profile.id) }}" class="btn btn-primary mt-2">
                                            <i class="fas fa-plus"></i> Add Words
                                        </a>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Flashcard Mode Toggle -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <button class="btn btn-lg btn-primary" id="toggleFlashcardMode">
                <i class="fas fa-exchange-alt"></i> Switch to Flashcard Mode
            </button>
        </div>
    </div>
    
    <!-- Flashcard View (Hidden by Default) -->
    <div id="flashcardView" class="d-none mt-4">
        <div class="row mb-3">
            <div class="col-12 text-center">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary active" id="showFrontFirst">{{ profile.language_name }} → {{ profile.native_language_name }}</button>
                    <button class="btn btn-outline-secondary" id="showBackFirst">{{ profile.native_language_name }} → {{ profile.language_name }}</button>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card-flip mb-4" id="flashcard">
                    <div class="card-flip-inner">
                        <div class="card card-front">
                            <div class="card-body text-center">
                                <h3 id="flashcardFront"></h3>
                                <p class="text-muted mt-3" id="flashcardHint"></p>
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-primary" id="playFrontPronunciation">
                                        <i class="fas fa-volume-up"></i> Listen
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card card-back">
                            <div class="card-body text-center">
                                <h3 id="flashcardBack"></h3>
                                <p class="text-muted mt-3" id="flashcardPronunciation"></p>
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-primary" id="playBackPronunciation">
                                        <i class="fas fa-volume-up"></i> Listen
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-lg btn-outline-secondary" id="prevFlashcard">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    
                    <div>
                        <button class="btn btn-lg btn-outline-danger me-2" id="markIncorrect">
                            <i class="fas fa-times"></i> Missed
                        </button>
                        <button class="btn btn-lg btn-outline-success" id="markCorrect">
                            <i class="fas fa-check"></i> Got It
                        </button>
                    </div>
                    
                    <button class="btn btn-lg btn-outline-secondary" id="nextFlashcard">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <div class="progress mt-4" style="height: 10px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="flashcardProgress"></div>
                </div>
                <div class="text-center mt-2">
                    <span id="flashcardCounter">0/0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Vocabulary Modal -->
<div class="modal fade" id="editVocabularyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Vocabulary Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editVocabularyForm">
                    <input type="hidden" id="editItemId">
                    
                    <div class="mb-3">
                        <label for="editWord" class="form-label">Word ({{ profile.language_name }})</label>
                        <input type="text" class="form-control" id="editWord" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTranslation" class="form-label">Translation ({{ profile.native_language_name }})</label>
                        <input type="text" class="form-control" id="editTranslation" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPronunciation" class="form-label">Pronunciation</label>
                        <input type="text" class="form-control" id="editPronunciation">
                        <div class="form-text">How to pronounce this word (phonetic spelling)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPartOfSpeech" class="form-label">Part of Speech</label>
                        <select class="form-select" id="editPartOfSpeech">
                            <option value="">-- Select --</option>
                            <option value="noun">Noun</option>
                            <option value="verb">Verb</option>
                            <option value="adjective">Adjective</option>
                            <option value="adverb">Adverb</option>
                            <option value="preposition">Preposition</option>
                            <option value="conjunction">Conjunction</option>
                            <option value="pronoun">Pronoun</option>
                            <option value="interjection">Interjection</option>
                            <option value="phrase">Phrase</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editExample" class="form-label">Example Sentence</label>
                        <textarea class="form-control" id="editExample" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveVocabularyChanges">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filters toggle
        const toggleFilters = document.getElementById('toggleFilters');
        const filterPanel = document.getElementById('filterPanel');
        
        toggleFilters.addEventListener('click', function() {
            filterPanel.classList.toggle('show');
        });
        
        // Toggle flashcard mode
        const toggleFlashcardMode = document.getElementById('toggleFlashcardMode');
        const flashcardView = document.getElementById('flashcardView');
        const vocabularyTable = document.getElementById('vocabularyTable').closest('.row');
        
        toggleFlashcardMode.addEventListener('click', function() {
            const isInTableMode = flashcardView.classList.contains('d-none');
            
            if (isInTableMode) {
                flashcardView.classList.remove('d-none');
                vocabularyTable.classList.add('d-none');
                toggleFlashcardMode.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to Table Mode';
                initializeFlashcards();
            } else {
                flashcardView.classList.add('d-none');
                vocabularyTable.classList.remove('d-none');
                toggleFlashcardMode.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to Flashcard Mode';
            }
        });
        
        // Flashcard interaction
        const flashcard = document.getElementById('flashcard');
        
        flashcard.addEventListener('click', function() {
            this.classList.toggle('flipped');
        });
        
        // Play pronunciation buttons
        const pronunciationButtons = document.querySelectorAll('.btn-play-pronunciation');
        
        pronunciationButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                const word = this.getAttribute('data-word');
                const language = this.getAttribute('data-language');
                
                // Play pronunciation (would be replaced with actual API call)
                alert(`Playing pronunciation for "${word}" in ${language}`);
            });
        });
        
        // Flashcards functionality
        let currentFlashcardIndex = 0;
        let flashcards = [];
        let frontFirst = true;
        
        function initializeFlashcards() {
            // Get vocabulary items from the table
            const rows = document.querySelectorAll('.vocabulary-item');
            flashcards = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                flashcards.push({
                    id: row.querySelector('.btn-edit').getAttribute('data-id'),
                    word: cells[0].textContent,
                    translation: cells[1].textContent,
                    partOfSpeech: cells[2].textContent,
                    pronunciation: cells[3].querySelector('span') ? cells[3].querySelector('span').textContent : '',
                    mastery: parseFloat(row.getAttribute('data-mastery'))
                });
            });
            
            // Sort by mastery level (lowest first)
            flashcards.sort((a, b) => a.mastery - b.mastery);
            
            currentFlashcardIndex = 0;
            updateFlashcard();
            updateFlashcardCounter();
        }
        
        function updateFlashcard() {
            if (flashcards.length === 0) {
                document.getElementById('flashcardFront').textContent = 'No vocabulary items';
                document.getElementById('flashcardBack').textContent = 'Add some words to practice';
                document.getElementById('flashcardHint').textContent = '';
                document.getElementById('flashcardPronunciation').textContent = '';
                return;
            }
            
            const card = flashcards[currentFlashcardIndex];
            
            if (frontFirst) {
                document.getElementById('flashcardFront').textContent = card.word;
                document.getElementById('flashcardBack').textContent = card.translation;
                document.getElementById('flashcardHint').textContent = card.partOfSpeech;
            } else {
                document.getElementById('flashcardFront').textContent = card.translation;
                document.getElementById('flashcardBack').textContent = card.word;
                document.getElementById('flashcardHint').textContent = '';
            }
            
            document.getElementById('flashcardPronunciation').textContent = card.pronunciation;
            
            // Reset flip state
            flashcard.classList.remove('flipped');
        }
        
        function updateFlashcardCounter() {
            const counter = document.getElementById('flashcardCounter');
            const progress = document.getElementById('flashcardProgress');
            
            if (flashcards.length === 0) {
                counter.textContent = '0/0';
                progress.style.width = '0%';
                return;
            }
            
            counter.textContent = `${currentFlashcardIndex + 1}/${flashcards.length}`;
            const percentage = ((currentFlashcardIndex + 1) / flashcards.length) * 100;
            progress.style.width = `${percentage}%`;
        }
        
        // Flashcard navigation buttons
        document.getElementById('prevFlashcard').addEventListener('click', function() {
            if (currentFlashcardIndex > 0) {
                currentFlashcardIndex--;
                updateFlashcard();
                updateFlashcardCounter();
            }
        });
        
        document.getElementById('nextFlashcard').addEventListener('click', function() {
            if (currentFlashcardIndex < flashcards.length - 1) {
                currentFlashcardIndex++;
                updateFlashcard();
                updateFlashcardCounter();
            }
        });
        
        // Flashcard direction buttons
        document.getElementById('showFrontFirst').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('showBackFirst').classList.remove('active');
            frontFirst = true;
            updateFlashcard();
        });
        
        document.getElementById('showBackFirst').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('showFrontFirst').classList.remove('active');
            frontFirst = false;
            updateFlashcard();
        });
        
        // Mark mastery buttons
        document.getElementById('markCorrect').addEventListener('click', function() {
            if (flashcards.length === 0) return;
            
            const itemId = flashcards[currentFlashcardIndex].id;
            
            // This would be replaced with API call to update mastery
            console.log(`Marking item ${itemId} as correct`);
            
            // Move to next flashcard
            if (currentFlashcardIndex < flashcards.length - 1) {
                currentFlashcardIndex++;
                updateFlashcard();
                updateFlashcardCounter();
            }
        });
        
        document.getElementById('markIncorrect').addEventListener('click', function() {
            if (flashcards.length === 0) return;
            
            const itemId = flashcards[currentFlashcardIndex].id;
            
            // This would be replaced with API call to update mastery
            console.log(`Marking item ${itemId} as incorrect`);
            
            // Move to next flashcard
            if (currentFlashcardIndex < flashcards.length - 1) {
                currentFlashcardIndex++;
                updateFlashcard();
                updateFlashcardCounter();
            }
        });
        
        // Pronunciation buttons in flashcards
        document.getElementById('playFrontPronunciation').addEventListener('click', function(e) {
            e.stopPropagation();
            if (flashcards.length === 0) return;
            
            const word = document.getElementById('flashcardFront').textContent;
            alert(`Playing pronunciation for "${word}"`);
        });
        
        document.getElementById('playBackPronunciation').addEventListener('click', function(e) {
            e.stopPropagation();
            if (flashcards.length === 0) return;
            
            const word = document.getElementById('flashcardBack').textContent;
            alert(`Playing pronunciation for "${word}"`);
        });
        
        // Edit vocabulary item
        const editButtons = document.querySelectorAll('.btn-edit');
        
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.getAttribute('data-id');
                const row = this.closest('tr');
                const cells = row.querySelectorAll('td');
                
                document.getElementById('editItemId').value = itemId;
                document.getElementById('editWord').value = cells[0].textContent;
                document.getElementById('editTranslation').value = cells[1].textContent;
                
                const partOfSpeech = cells[2].textContent.trim().toLowerCase();
                document.getElementById('editPartOfSpeech').value = partOfSpeech === '-' ? '' : partOfSpeech;
                
                const pronunciation = cells[3].querySelector('span') ? cells[3].querySelector('span').textContent : '';
                document.getElementById('editPronunciation').value = pronunciation;
                
                // Open modal
                const modal = new bootstrap.Modal(document.getElementById('editVocabularyModal'));
                modal.show();
            });
        });
        
        // Save vocabulary changes
        document.getElementById('saveVocabularyChanges').addEventListener('click', function() {
            const itemId = document.getElementById('editItemId').value;
            const word = document.getElementById('editWord').value;
            const translation = document.getElementById('editTranslation').value;
            const pronunciation = document.getElementById('editPronunciation').value;
            const partOfSpeech = document.getElementById('editPartOfSpeech').value;
            const example = document.getElementById('editExample').value;
            const notes = document.getElementById('editNotes').value;
            
            // This would be replaced with API call to update item
            console.log(`Updating vocabulary item ${itemId}`);
            console.log({ word, translation, pronunciation, partOfSpeech, example, notes });
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editVocabularyModal')).hide();
            
            // Show success message
            alert('Vocabulary item updated successfully!');
        });
        
        // Delete vocabulary item
        const deleteButtons = document.querySelectorAll('.btn-delete');
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this vocabulary item?')) {
                    const itemId = this.getAttribute('data-id');
                    
                    // This would be replaced with API call to delete item
                    console.log(`Deleting vocabulary item ${itemId}`);
                    
                    // Remove row from table
                    this.closest('tr').remove();
                }
            });
        });
        
        // Search and filtering functionality
        const searchInput = document.getElementById('searchVocab');
        const masteryFilter = document.getElementById('masteryFilter');
        const partOfSpeechFilter = document.getElementById('partOfSpeechFilter');
        const sortByFilter = document.getElementById('sortBy');
        
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const masteryLevel = masteryFilter.value;
            const partOfSpeech = partOfSpeechFilter.value;
            
            const rows = document.querySelectorAll('.vocabulary-item');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const wordText = cells[0].textContent.toLowerCase();
                const translationText = cells[1].textContent.toLowerCase();
                const partOfSpeechText = cells[2].textContent.toLowerCase();
                const mastery = parseFloat(row.getAttribute('data-mastery'));
                
                let showRow = true;
                
                // Search term filter
                if (searchTerm && !wordText.includes(searchTerm) && !translationText.includes(searchTerm)) {
                    showRow = false;
                }
                
                // Mastery level filter
                if (masteryLevel !== 'all') {
                    if (masteryLevel === 'beginner' && mastery >= 0.3) showRow = false;
                    if (masteryLevel === 'learning' && (mastery < 0.3 || mastery >= 0.7)) showRow = false;
                    if (masteryLevel === 'mastered' && mastery < 0.7) showRow = false;
                }
                
                // Part of speech filter
                if (partOfSpeech !== 'all' && !partOfSpeechText.includes(partOfSpeech)) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        // Apply filters on input/change
        searchInput.addEventListener('input', applyFilters);
        masteryFilter.addEventListener('change', applyFilters);
        partOfSpeechFilter.addEventListener('change', applyFilters);
        
        // Sorting functionality
        sortByFilter.addEventListener('change', function() {
            const sortValue = this.value;
            const tableBody = document.querySelector('#vocabularyTable tbody');
            const rows = Array.from(tableBody.querySelectorAll('tr.vocabulary-item'));
            
            // Remove empty row if it exists
            const emptyRow = tableBody.querySelector('tr:not(.vocabulary-item)');
            if (emptyRow) emptyRow.remove();
            
            // Sort rows
            rows.sort((a, b) => {
                const aData = a.querySelectorAll('td');
                const bData = b.querySelectorAll('td');
                
                if (sortValue === 'alphabetical') {
                    return aData[0].textContent.localeCompare(bData[0].textContent);
                } else if (sortValue === 'alphabetical_desc') {
                    return bData[0].textContent.localeCompare(aData[0].textContent);
                } else if (sortValue === 'mastery') {
                    return parseFloat(a.getAttribute('data-mastery')) - parseFloat(b.getAttribute('data-mastery'));
                } else if (sortValue === 'mastery_desc') {
                    return parseFloat(b.getAttribute('data-mastery')) - parseFloat(a.getAttribute('data-mastery'));
                } else if (sortValue === 'reviewed') {
                    const aDate = aData[5].textContent === 'Never' ? new Date(0) : new Date(aData[5].textContent);
                    const bDate = bData[5].textContent === 'Never' ? new Date(0) : new Date(bData[5].textContent);
                    return bDate - aDate;
                }
                
                return 0;
            });
            
            // Reattach sorted rows
            rows.forEach(row => {
                tableBody.appendChild(row);
            });
            
            // Re-add empty row if there were no rows
            if (rows.length === 0 && emptyRow) {
                tableBody.appendChild(emptyRow);
            }
        });
    });
</script>
{% endblock %}